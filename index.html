<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ì„±ì‹¤ ë ˆë²¨ ì—… í”„ë¡œì íŠ¸ â€” PWA (v7: Categories Fix)</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f172a">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/htm@3.1.1/dist/htm.umd.js"></script>
  <style>
    html,body{height:100%}
    .card{ border-radius:1rem; border:1px solid #e2e8f0; background:#fff; box-shadow:0 1px 2px rgba(0,0,0,.04); }
    .btn{ display:inline-flex; align-items:center; justify-content:center; padding:.5rem .75rem; border-radius:.75rem; border:1px solid #cbd5e1; background:#fff; }
    .btn:hover{ background:#f8fafc }
    .btn-primary{ background:#0f172a; color:#fff; border-color:#0f172a }
    .btn-ghost{ border-color:transparent }
    .input{ width:100%; border:1px solid #cbd5e1; border-radius:.75rem; padding:.5rem .75rem }
    .label{ font-size:.75rem; color:#475569 }
  </style>
</head>
<body class="min-h-full bg-gradient-to-b from-slate-50 to-white text-slate-900 p-4 md:p-8">
  <div id="root"></div>

  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./sw.js").catch(()=>{});
      });
    }
  </script>

  <script>
    const html = htm.bind(React.createElement);
    const LS_KEY = 'dlu.v7.categories.fix';
    const fmtDate = d => new Date(d).toISOString().slice(0,10);
    const todayStr = fmtDate(new Date());
    const uuid = () => (window.crypto && crypto.randomUUID ? crypto.randomUUID() : ('id_' + Math.random().toString(36).slice(2)));

    const defaultCategories = ['ë‹¤ì´ì–´íŠ¸','ê·¸ë¦¼','ì½”ë”©/ìê²©ì¦','ì˜ì–´','ìƒí™œ êµì–‘','ì±… ì“°ê¸°','ìƒí™œ ìŠµê´€','ê¸°íƒ€'];

    const seedMissions = () => ([
      { id: uuid(), title:'ìœ ì‚°ì†Œ ìš´ë™ 40ë¶„', category:'ë‹¤ì´ì–´íŠ¸', plannedXp:40, done:false },
      { id: uuid(), title:'í¬ë¡œí‚¤ 2ì¥', category:'ê·¸ë¦¼', plannedXp:35, done:false },
      { id: uuid(), title:'C ê°•ì˜ 1ê°•', category:'ì½”ë”©/ìê²©ì¦', plannedXp:30, done:false },
      { id: uuid(), title:'ì˜ë‹¨ì–´ ì•”ê¸° 30ë¶„', category:'ì˜ì–´', plannedXp:25, done:false },
    ]);

    const save = (s) => localStorage.setItem(LS_KEY, JSON.stringify(s));
    const load = () => { try { const raw = localStorage.getItem(LS_KEY); return raw ? JSON.parse(raw) : null } catch { return null } };

    function migrate(s){
      s = s || {};
      s.categories = Array.isArray(s.categories)&&s.categories.length? s.categories : defaultCategories.slice();
      if(!s.categories.includes('ê¸°íƒ€')) s.categories.push('ê¸°íƒ€');
      s.days = s.days || {};
      if(!s.days[todayStr]) s.days[todayStr] = { date: todayStr, missions: seedMissions() };
      return s;
    }

    function App(){
      const [state, setState] = React.useState(() => migrate(load()));

      const [selectedDate, setSelectedDate] = React.useState(todayStr);
      React.useEffect(() => { save(state); }, [state]);

      const day = state.days[selectedDate] || { date:selectedDate, missions:[] };
      React.useEffect(() => {
        if(!state.days[selectedDate]){
          setState(prev => ({...prev, days:{...prev.days, [selectedDate]: { date:selectedDate, missions:[] }}}));
        }
      }, [selectedDate]);

      function CategoriesTab(){
        return html`<div className="space-y-4">
          <div className="text-base font-semibold">ğŸ·ï¸ ì¹´í…Œê³ ë¦¬ ê´€ë¦¬</div>
          <div className="text-xs text-slate-500">* ì‚­ì œ ì‹œ í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ë¯¸ì…˜ì€ â€œê¸°íƒ€â€ë¡œ ì´ë™í•©ë‹ˆë‹¤. â€œê¸°íƒ€â€ëŠ” í•­ìƒ ìœ ì§€ë©ë‹ˆë‹¤.</div>
          <div className="space-y-2">
            ${state.categories.map((c, idx) => html`
              <div key=${idx} className="border rounded-xl p-3 flex items-center gap-2">
                <input className="input flex-1" value=${c} onChange=${e => {
                  const v = e.target.value;
                  setState(prev => {
                    const cats = prev.categories.slice();
                    cats[idx] = v;
                    return {...prev, categories: cats};
                  });
                }} />
                <button className="btn btn-ghost" disabled=${c==='ê¸°íƒ€'} onClick=${() => {
                  if(!confirm('ì‚­ì œí• ê¹Œìš”? ì´ ì¹´í…Œê³ ë¦¬ì˜ ë¯¸ì…˜ì€ â€œê¸°íƒ€â€ë¡œ ì´ë™í•©ë‹ˆë‹¤.')) return;
                  setState(prev => {
                    const cats = prev.categories.filter(x => x!==c);
                    if(!cats.includes('ê¸°íƒ€')) cats.push('ê¸°íƒ€');
                    const days = {};
                    Object.entries(prev.days).forEach(([k,d]) => {
                      const missions = (d.missions||[]).map(m => m.category===c? {...m, category:'ê¸°íƒ€'} : m);
                      days[k] = {...d, missions};
                    });
                    return {...prev, categories: cats, days};
                  });
                }}>ğŸ—‘ï¸ ì‚­ì œ</button>
              </div>
            `)}
          </div>
          <div><button className="btn" onClick=${() => {
            let name='ìƒˆ ì¹´í…Œê³ ë¦¬'; let i=1;
            while(state.categories.includes(name)){ i++; name='ìƒˆ ì¹´í…Œê³ ë¦¬ '+i; }
            setState(prev => ({...prev, categories:[...prev.categories, name]}));
          }}>â• ì¹´í…Œê³ ë¦¬ ì¶”ê°€</button></div>
        </div>`;
      }

      function MissionsTab(){
        return html`<div className="space-y-3">
          ${day.missions.length===0 && html`<div className="text-sm text-slate-500">ë¯¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤. ì•„ë˜ ë²„íŠ¼ìœ¼ë¡œ ì¶”ê°€í•´ ë³´ì„¸ìš”.</div>`}
          ${day.missions.map(m => html`
            <div key=${m.id} className="border rounded-xl p-3 grid md:grid-cols-12 gap-2 items-center">
              <div className="md:col-span-4">
                <input className="input" value=${m.title} onChange=${e => {
                  setState(prev => {
                    const missions = day.missions.map(mm => mm.id===m.id? {...mm, title:e.target.value}: mm);
                    return {...prev, days:{...prev.days, [selectedDate]: {...day, missions}}};
                  });
                }} />
              </div>
              <div className="md:col-span-3">
                <select className="input" value=${m.category} onChange=${e => {
                  setState(prev => {
                    const missions = day.missions.map(mm => mm.id===m.id? {...mm, category:e.target.value}: mm);
                    return {...prev, days:{...prev.days, [selectedDate]: {...day, missions}}};
                  });
                }}>
                  ${state.categories.map(c => html`<option key=${c} value=${c}>${c}</option>`)}
                </select>
              </div>
              <div className="md:col-span-3">
                <input className="input" type="number" value=${m.plannedXp} onChange=${e => {
                  setState(prev => {
                    const missions = day.missions.map(mm => mm.id===m.id? {...mm, plannedXp:Number(e.target.value)||0}: mm);
                    return {...prev, days:{...prev.days, [selectedDate]: {...day, missions}}};
                  });
                }} />
              </div>
              <div className="md:col-span-2 flex justify-end gap-2">
                <button className=${"btn " + (m.done? 'btn-primary':'')} onClick=${() => {
                  setState(prev => {
                    const missions = day.missions.map(mm => mm.id===m.id? {...mm, done:!m.done}: mm);
                    return {...prev, days:{...prev.days, [selectedDate]: {...day, missions}}};
                  });
                }}>${m.done? 'âœ… ì™„ë£Œ':'â€¦ ë¯¸ì™„ë£Œ'}</button>
                <button className="btn btn-ghost" onClick=${() => {
                  setState(prev => {
                    const missions = day.missions.filter(mm => mm.id!==m.id);
                    return {...prev, days:{...prev.days, [selectedDate]: {...day, missions}}};
                  });
                }}>ğŸ—‘ï¸</button>
              </div>
            </div>
          `)}
          <button className="btn" onClick=${() => {
            setState(prev => {
              const missions = [...day.missions, { id: uuid(), title:'ìƒˆ ë¯¸ì…˜', category: state.categories[0]||'ê¸°íƒ€', plannedXp:20, done:false }];
              return {...prev, days:{...prev.days, [selectedDate]: {...day, missions}}};
            });
          }}>â• ìƒˆ ë¯¸ì…˜ ë§Œë“¤ê¸°</button>
        </div>`;
      }

      return html`<div className="max-w-5xl mx-auto grid gap-6">
        <div className="flex items-center justify-between gap-3">
          <h1 className="text-2xl md:text-3xl font-bold">ì„±ì‹¤ ë ˆë²¨ ì—… í”„ë¡œì íŠ¸ (ì¹´í…Œê³ ë¦¬)</h1>
          <div className="flex items-center gap-2">
            <input type="date" className="input" value=${selectedDate} onChange=${e=> setSelectedDate(e.target.value)} />
            <button className="btn" onClick=${() => setSelectedDate(todayStr)}>ì˜¤ëŠ˜</button>
          </div>
        </div>

        <div className="grid md:grid-cols-2 gap-4">
          <div className="card p-4">
            <div className="text-lg font-semibold mb-3">ğŸ·ï¸ ì¹´í…Œê³ ë¦¬</div>
            ${html`<${CategoriesTab} />`}
          </div>
          <div className="card p-4">
            <div className="text-lg font-semibold mb-3">ğŸ“‹ ì˜¤ëŠ˜ì˜ ë¯¸ì…˜</div>
            ${html`<${MissionsTab} />`}
          </div>
        </div>

        <div className="text-center text-xs text-slate-500 py-6">Â© ${new Date().getFullYear()} ì„±ì‹¤ ë ˆë²¨ ì—… í”„ë¡œì íŠ¸ Â· PWA</div>
      </div>`;
    }
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(html`<${App} />`);
  </script>
</body>
</html>