<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>성실 레벨 업 프로젝트 — PWA(Autoweek+Report)</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f172a">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    html,body{height:100%}
    .card{ border-radius:1rem; border:1px solid #e2e8f0; background:#fff; box-shadow:0 1px 2px rgba(0,0,0,.04); }
    .btn{ display:inline-flex; align-items:center; justify-content:center; padding:.5rem .75rem; border-radius:.75rem; border:1px solid #cbd5e1; background:#fff; }
    .btn:hover{ background:#f8fafc }
    .btn-primary{ background:#0f172a; color:#fff; border-color:#0f172a }
    .btn-ghost{ border-color:transparent }
    .input{ width:100%; border:1px solid #cbd5e1; border-radius:.75rem; padding:.5rem .75rem }
    .label{ font-size:.75rem; color:#475569 }
    .switch{ width:38px; height:22px }
    .switch input{ display:none }
    .switch span{ display:block; width:100%; height:100%; background:#e2e8f0; border-radius:9999px; position:relative; transition:.2s }
    .switch span:after{ content:''; position:absolute; top:2px; left:2px; width:18px; height:18px; background:#fff; border-radius:9999px; transition:.2s; box-shadow:0 1px 2px rgba(0,0,0,.2) }
    .switch input:checked + span{ background:#0f172a }
    .switch input:checked + span:after{ transform:translateX(16px) }
    .pixelate{ image-rendering: pixelated }
  </style>
</head>
<body class="min-h-full bg-gradient-to-b from-slate-50 to-white text-slate-900 p-4 md:p-8">
  <div id="root"></div>

  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./sw.js").catch(()=>{});
      });
    }
  </script>

  <!-- NOTE: Explicitly set React preset to avoid blank page on GH Pages -->
  <script type="text/babel" data-presets="react">
    const CATEGORIES = ['다이어트','그림','코딩/자격증','영어','생활 교양','책 쓰기','생활 습관'];
    const LS_KEY = 'diligence-level-up-app.v3fix';
    const fmtDate = d => new Date(d).toISOString().slice(0,10);
    const todayStr = fmtDate(new Date());
    const DAY_MS = 24*60*60*1000;
    const defaultWeeklyGoals = [
      { category: '그림', targetCount: 5, achievedCount: 0 },
      { category: '코딩/자격증', targetCount: 4, achievedCount: 0 },
      { category: '영어', targetCount: 5, achievedCount: 0 },
      { category: '다이어트', targetCount: 5, achievedCount: 0 },
      { category: '생활 습관', targetCount: 4, achievedCount: 0 },
      { category: '생활 교양', targetCount: 2, achievedCount: 0 },
      { category: '책 쓰기', targetCount: 2, achievedCount: 0 },
    ];
    const defaultInventory = () => ({
      fragments: { '탐식의 마도서':0, '환식의 계약서':0, '현자의 보급 주문서':0, '소망의 결정':0 },
      items: { '탐식의 마도서':0, '환식의 계약서':0, '현자의 보급 주문서':0, '소망의 결정':0 },
    });
    const seedMissions = () => ([
      { id: crypto.randomUUID(), title:'유산소 운동 40분', category:'다이어트', plannedXp:40, done:false, pixelate:true },
      { id: crypto.randomUUID(), title:'크로키 2장', category:'그림', plannedXp:35, done:false, pixelate:true },
      { id: crypto.randomUUID(), title:'C 강의 1강', category:'코딩/자격증', plannedXp:30, done:false },
      { id: crypto.randomUUID(), title:'영단어 암기 30분', category:'영어', plannedXp:25, done:false },
    ]);
    const clamp01 = x => Math.max(0, Math.min(1, x));
    const percent = n => Math.round(n*100);
    const xpForMission = (m, rates) => {
      const base = Number(m.plannedXp)||0;
      const extra = m.isExtra ? base * rates.extraMissionRate : base;
      return m.done ? extra : base * rates.xpPenaltyRate;
    };
    const save = (s) => localStorage.setItem(LS_KEY, JSON.stringify(s));
    const load = () => { try { const raw = localStorage.getItem(LS_KEY); return raw ? JSON.parse(raw) : null } catch { return null } };

    function useSfx(enabled, volume){
      const sounds = React.useMemo(()=> ({
        click: new Audio("./click.wav"),
        success: new Audio("./success.wav"),
        fail: new Audio("./fail.wav"),
      }), []);
      React.useEffect(()=> { Object.values(sounds).forEach(a => a.volume = volume); }, [volume]);
      const play = React.useCallback((name) => {
        if(!enabled) return;
        const a = sounds[name];
        if(a){ try { a.currentTime = 0; a.play(); } catch(e){} }
      }, [enabled, sounds]);
      return play;
    }
    const weekOf = (startDateStr, anyDateStr) => {
      const s = new Date(startDateStr + 'T00:00:00');
      const d = new Date(anyDateStr + 'T00:00:00');
      const diff = Math.floor((d - s)/(24*60*60*1000));
      return Math.max(1, Math.floor(diff/7)+1);
    };

    function App(){
      const [state, setState] = React.useState(() => load() ?? ({
        profile: { level: 8, xp: 309, nextLevelXp: 700 },
        weekNumber: 7,
        weeklyGoals: defaultWeeklyGoals,
        days: { [todayStr]: { date: todayStr, missions: seedMissions(), settled:false, dayXpAwarded:0 } },
        inventory: defaultInventory(),
        settings: { xpPenaltyRate:0.5, extraMissionRate:0.6, minibossRewardFragments:1, locale:'ko-KR', sfx:true, sfxVolume:0.4, autoWeek:true, weekStartDate: todayStr },
        quickNote: ''
      }));
      const [selectedDate, setSelectedDate] = React.useState(todayStr);
      const playSfx = useSfx(state.settings.sfx, state.settings.sfxVolume);
      React.useEffect(()=>{ save(state); }, [state]);

      const day = React.useMemo(()=> state.days[selectedDate] ?? { date:selectedDate, missions:[], settled:false, dayXpAwarded:0 }, [state, selectedDate]);
      React.useEffect(()=>{ if(!state.days[selectedDate]){
        setState(prev=> ({...prev, days:{...prev.days, [selectedDate]: { date:selectedDate, missions:[], settled:false, dayXpAwarded:0 } }}));
      }} , [selectedDate]);

      const completionRate = React.useMemo(()=>{
        const total = day.missions.length || 1;
        const done = day.missions.filter(m=>m.done).length;
        return done/total;
      }, [day.missions]);
      const minibossChance = percent(clamp01(completionRate * 1.2));
      const currentWeekAuto = weekOf(state.settings.weekStartDate, selectedDate);
      const displayWeek = state.settings.autoWeek ? currentWeekAuto : (state.weekNumber || 1);

      function addMission(partial={}){
        const m = { id:crypto.randomUUID(), title:'새 미션', category:'생활 습관', plannedXp:20, done:false, ...partial };
        setState(prev=> ({...prev, days:{...prev.days, [selectedDate]: {...day, missions:[...day.missions, m] }}}));
        playSfx('click');
      }
      function updateMission(id, patch){
        setState(prev=> ({...prev, days:{...prev.days, [selectedDate]: {...day, missions: day.missions.map(m=> m.id===id? {...m, ...patch}: m) }}}));
      }
      function removeMission(id){
        setState(prev=> ({...prev, days:{...prev.days, [selectedDate]: {...day, missions: day.missions.filter(m=>m.id!==id) }}}));
      }
      function toggleDone(id){
        const m = day.missions.find(x=>x.id===id);
        const to = !(m && m.done);
        updateMission(id, {done: to});
        playSfx('click');
      }

      return (
        <div className="max-w-6xl mx-auto grid gap-6">
          <div className="flex items-center justify-between gap-3">
            <div className="flex items-center gap-3 flex-wrap">
              <div className="text-2xl">✨</div>
              <h1 className="text-2xl md:text-3xl font-bold">성실 레벨 업 프로젝트 (PWA)</h1>
              <div className="flex items-center gap-2">
                <span className="px-2 py-1 rounded-xl bg-slate-100 text-slate-700 text-sm">주차</span>
                {state.settings.autoWeek ? (
                  <div className="flex items-center gap-2">
                    <span className="px-2 py-1 rounded-xl bg-slate-100">{displayWeek}주차</span>
                    <span className="text-xs text-slate-500">자동</span>
                  </div>
                ) : (
                  <div className="flex items-center gap-2">
                    <button className="btn" onClick={()=> setState(p=> ({...p, weekNumber: Math.max(1, (p.weekNumber||1)-1)}))}>-</button>
                    <input className="input w-20 text-center" type="number" min="1" value={state.weekNumber} onChange={e=> setState(p=> ({...p, weekNumber: Math.max(1, Number(e.target.value)||1)}))} />
                    <button className="btn" onClick={()=> setState(p=> ({...p, weekNumber: (p.weekNumber||1)+1}))}>+</button>
                    <span className="text-xs text-slate-500">수동</span>
                  </div>
                )}
              </div>
            </div>
            <div className="flex items-center gap-2">
              <button className="btn" onClick={()=>{
                const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
                const url = URL.createObjectURL(blob); const a=document.createElement('a');
                a.href=url; a.download=`성실레벨업_${displayWeek}주차_${selectedDate}.json`; a.click(); URL.revokeObjectURL(url);
              }}>⬇️ 내보내기</button>
            </div>
          </div>

          <div className="grid md:grid-cols-3 gap-4">
            <div className="card p-4">
              <div className="text-lg font-semibold mb-3">🛡️ 프로필</div>
              <div className="grid grid-cols-3 gap-3 items-end">
                <div><div className="label">레벨</div><input className="input" type="number" value={state.profile.level} onChange={e=> setState(p=>({...p, profile:{...p.profile, level:Number(e.target.value)}}))} /></div>
                <div><div className="label">경험치</div><input className="input" type="number" value={state.profile.xp} onChange={e=> setState(p=>({...p, profile:{...p.profile, xp:Number(e.target.value)}}))} /></div>
                <div><div className="label">다음 레벨 필요치</div><input className="input" type="number" value={state.profile.nextLevelXp} onChange={e=> setState(p=>({...p, profile:{...p.profile, nextLevelXp:Number(e.target.value)}}))} /></div>
              </div>
            </div>

            <div className="card p-4">
              <div className="text-lg font-semibold mb-3">📅 오늘</div>
              <div className="grid gap-3">
                <div className="flex items-center gap-2">
                  <input className="input" type="date" value={selectedDate} onChange={e=> setSelectedDate(e.target.value)} />
                  <button className="btn" onClick={()=> setSelectedDate(todayStr)}>오늘</button>
                </div>
                <div className="flex items-center justify-between"><div className="text-sm text-slate-600">달성률</div><div className="text-lg font-semibold">{percent((day.missions.filter(m=>m.done).length)/(day.missions.length||1))}%</div></div>
                <div className="h-2 bg-slate-200 rounded-xl overflow-hidden"><div className="h-full bg-slate-900" style={{width:`${percent((day.missions.filter(m=>m.done).length)/(day.missions.length||1))}%`}}/></div>
              </div>
            </div>

            <div className="card p-4">
              <div className="text-lg font-semibold mb-3">🏆 주간 진행</div>
              <div className="space-y-3">
                <div className="text-sm text-slate-600">주간 종합 진행률</div>
                <div className="h-2 bg-slate-200 rounded-xl overflow-hidden"><div className="h-full bg-slate-900" style={{width:`${50}%`}}/></div>
                <div className="text-xs text-slate-500">* 간략 버전 (리포트 탭에서 전체 집계 확인)</div>
              </div>
            </div>
          </div>

          <div className="card p-4">
            <div className="text-sm text-slate-600">간단 테스트: 화면이 보이면 Babel/React 로딩 OK</div>
          </div>
        </div>
      );
    }
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App/>);
  </script>
</body>
</html>