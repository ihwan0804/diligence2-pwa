<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>ì„±ì‹¤ ë ˆë²¨ ì—… í”„ë¡œì íŠ¸ â€” PWA (v9.10)</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f172a">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/htm@3.1.1/dist/htm.umd.js"></script>
  <style>
    html,body{height:100%}
    .card{ border-radius:1rem; border:1px solid #e2e8f0; background:#fff; box-shadow:0 1px 2px rgba(0,0,0,.04); }
    .btn{ display:inline-flex; align-items:center; justify-content:center; padding:.5rem .75rem; border-radius:.75rem; border:1px solid #cbd5e1; background:#fff; }
    .btn:hover{ background:#f8fafc }
    .btn-primary{ background:#0f172a; color:#fff; border-color:#0f172a }
    .btn-ghost{ border-color:transparent }
    .input{ width:100%; border:1px solid #cbd5e1; border-radius:.75rem; padding:.5rem .75rem }
    .label{ font-size:.75rem; color:#475569 }
    .switch{ width:38px; height:22px }
    .switch input{ display:none }
    .switch span{ display:block; width:100%; height:100%; background:#e2e8f0; border-radius:9999px; position:relative; transition:.2s }
    .switch span:after{ content:''; position:absolute; top:2px; left:2px; width:18px; height:18px; background:#fff; border-radius:9999px; transition:.2s; box-shadow:0 1px 2px rgba(0,0,0,.2) }
    .switch input:checked + span{ background:#0f172a }
    .switch input:checked + span:after{ transform:translateX(16px) }
    .avatar{ width:96px; height:96px; border-radius:9999px; overflow:hidden; border:2px solid #cbd5e1; box-shadow:0 2px 4px rgba(0,0,0,.06); background:#f1f5f9; display:flex; align-items:center; justify-content:center }
    .avatar img{ width:100%; height:100%; object-fit:cover; image-rendering: pixelated }
    .avatar-sm{ width:72px; height:72px; border-radius:9999px; overflow:hidden; border:1px solid #cbd5e1; background:#f1f5f9; display:flex; align-items:center; justify-content:center }
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:flex; align-items:center; justify-content:center; padding:1rem }
  </style>
</head>
<body class="min-h-full bg-gradient-to-b from-slate-50 to-white text-slate-900 p-4 md:p-8">
  <div id="root"></div>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw-v910.js').catch(()=>{});
    }
  </script>

  <script>
    const html = htm.bind(React.createElement);
    const LS_KEY = 'dlu.v910.shieldfix';
    const DAY_MS = 24*60*60*1000;
    const fmtDate = d => new Date(d).toISOString().slice(0,10);
    const addDays = (dateStr, n) => fmtDate(new Date(new Date(dateStr+'T00:00:00').getTime() + n*DAY_MS));
    const todayStr = fmtDate(new Date());
    const clamp01 = x => Math.max(0, Math.min(1, x));
    const percent = n => Math.round(n*100);
    const uuid = () => (window.crypto && crypto.randomUUID ? crypto.randomUUID() : ('id_' + Math.random().toString(36).slice(2)));

    function weekIndexFromAnchor(anchorDateStr, anyDateStr){
      const a = new Date(anchorDateStr + 'T00:00:00');
      const b = new Date(anyDateStr + 'T00:00:00');
      const diffDays = Math.floor((b - a)/DAY_MS);
      return Math.max(1, Math.floor(diffDays / 7) + 1);
    }
    function weekStartFromAnchor(anchorDateStr, anyDateStr){
      const a = new Date(anchorDateStr + 'T00:00:00');
      const b = new Date(anyDateStr + 'T00:00:00');
      const diffDays = Math.floor((b - a)/DAY_MS);
      const k = Math.floor(diffDays / 7);
      const start = new Date(a.getTime() + k*7*DAY_MS);
      return fmtDate(start);
    }

    const defaultItemDefs = [
      { id: uuid(), name:'íƒì‹ì˜ ë§ˆë„ì„œ', hasFragments:true, combineCount:5, autoSupply:true, cap:3, description:'' },
      { id: uuid(), name:'í™˜ì‹ì˜ ê³„ì•½ì„œ', hasFragments:true, combineCount:5, autoSupply:true, cap:3, description:'' },
      { id: uuid(), name:'í˜„ìì˜ ë³´ê¸‰ ì£¼ë¬¸ì„œ', hasFragments:true, combineCount:5, autoSupply:true, cap:3, description:'' },
      { id: uuid(), name:'ì†Œë§ì˜ ê²°ì •', hasFragments:true, combineCount:5, autoSupply:false, cap:null, description:'' },
      { id: uuid(), name:'ì„±ì‹¤ ë°©ì–´ë§‰', hasFragments:false, combineCount:0, autoSupply:false, cap:3, description:'í•˜ë£¨ í˜ë„í‹°/ì†Œë©¸ ë©´ì œ' },
    ];
    const defaultCategories = ['ë‹¤ì´ì–´íŠ¸','ê·¸ë¦¼','ì½”ë”©/ìê²©ì¦','ì˜ì–´','ìƒí™œ êµì–‘','ì±… ì“°ê¸°','ìƒí™œ ìŠµê´€','ê¸°íƒ€'];
    const defaultWeeklyTemplate = ['í•µì‹¬ ìŠµê´€ A','í•µì‹¬ ìŠµê´€ B','í•µì‹¬ ìŠµê´€ C'];

    const defaultInventoryFromDefs = (defs) => {
      const items = {}; const fragments = {};
      defs.forEach(d => { items[d.name] = 0; if(d.hasFragments) fragments[d.name] = 0; });
      return { items, fragments };
    };

    function addItemWithCap(inv, defs, name, amount){
      const def = defs.find(d => d.name===name);
      const cap = (def && typeof def.cap==='number') ? def.cap : Infinity;
      const cur = inv.items[name] || 0;
      let next = cur + amount;
      if(amount >= 0) next = Math.min(cap, next);
      else next = Math.max(0, next);
      inv.items[name] = next;
    }
    function autoCombineFragments(inv, defs){
      defs.forEach(def => {
        if(!def.hasFragments) return;
        const need = Math.max(1, def.combineCount||5);
        inv.fragments[def.name] = inv.fragments[def.name] || 0;
        inv.items[def.name] = inv.items[def.name] || 0;
        while(inv.fragments[def.name] >= need){
          const cap = (typeof def.cap==='number') ? def.cap : Infinity;
          if(inv.items[def.name] >= cap) break;
          inv.fragments[def.name] -= need;
          inv.items[def.name] += 1;
        }
      });
    }
    function normalizeInventory(inv, defs){
      defs.forEach(def => {
        if(!(def.name in inv.items)) inv.items[def.name]=0;
        if(def.hasFragments && !(def.name in inv.fragments)) inv.fragments[def.name]=0;
        if(!def.hasFragments && (def.name in inv.fragments)) delete inv.fragments[def.name];
        const cap = (typeof def.cap==='number') ? def.cap : Infinity;
        if(inv.items[def.name] > cap) inv.items[def.name] = cap;
      });
      Object.keys(inv.items).forEach(k => { if(!defs.find(d=>d.name===k)) delete inv.items[k]; });
      Object.keys(inv.fragments).forEach(k => { if(!defs.find(d=>d.name===k && d.hasFragments)) delete inv.fragments[k]; });
    }

    function migrateState(s){
      s = s || {};
      s.profile = s.profile || { level: 1, xp: 0, nextLevelXp: 100 };
      if(!s.profile.avatarKind) s.profile.avatarKind = 'static';
      if(!s.profile.avatarKey) s.profile.avatarKey = 'port1';
      s.avatars = s.avatars || {};
      s.weekNumber = s.weekNumber || 1;
      s.itemDefs = Array.isArray(s.itemDefs)&&s.itemDefs.length? s.itemDefs : defaultItemDefs.map(d=>({...d, id: uuid()}));
      s.inventory = s.inventory || defaultInventoryFromDefs(s.itemDefs);
      normalizeInventory(s.inventory, s.itemDefs);
      s.settings = Object.assign({
        xpPenaltyRate:0.5, extraMissionRate:0.6, minibossRewardFragments:1,
        locale:'ko-KR', sfx:true, sfxVolume:0.4,
        autoWeek:true,
        weekAnchorDate: fmtDate(new Date()),
        supplyAnchorDate: fmtDate(new Date()),
        supplyGivenPeriods: 0
      }, s.settings||{});
      s.categories = Array.isArray(s.categories) && s.categories.length ? s.categories : defaultCategories.slice();
      if(!s.categories.includes('ê¸°íƒ€')) s.categories.push('ê¸°íƒ€');
      s.days = s.days || {};
      const hasAny = Object.values(s.days).some(d => (d.missions||[]).length>0);
      if(!hasAny){
        const cats = s.categories;
        s.days[fmtDate(new Date())] = { date: fmtDate(new Date()), missions: [
          { id: uuid(), title:'ìœ ì‚°ì†Œ ìš´ë™ 40ë¶„', category: cats.includes('ë‹¤ì´ì–´íŠ¸')?'ë‹¤ì´ì–´íŠ¸':(cats[0]||'ê¸°íƒ€'), plannedXp:40, done:false },
          { id: uuid(), title:'í¬ë¡œí‚¤ 2ì¥', category: cats.includes('ê·¸ë¦¼')?'ê·¸ë¦¼':(cats[0]||'ê¸°íƒ€'), plannedXp:35, done:false },
          { id: uuid(), title:'C ê°•ì˜ 1ê°•', category: cats.includes('ì½”ë”©/ìê²©ì¦')?'ì½”ë”©/ìê²©ì¦':(cats[0]||'ê¸°íƒ€'), plannedXp:30, done:false },
          { id: uuid(), title:'ì˜ë‹¨ì–´ ì•”ê¸° 30ë¶„', category: cats.includes('ì˜ì–´')?'ì˜ì–´':(cats[0]||'ê¸°íƒ€'), plannedXp:25, done:false },
        ], settled:false, dayXpAwarded:0, shieldUsed:false };
      } else {
        Object.values(s.days).forEach(d => { if(typeof d.shieldUsed === 'undefined') d.shieldUsed = false; });
      }
      s.weeklyChecks = s.weeklyChecks || {};
      s.weekTemplateTitles = s.weekTemplateTitles || defaultWeeklyTemplate.slice();
      const wk = weekStartFromAnchor(s.settings.weekAnchorDate, fmtDate(new Date()));
      if(!s.weeklyChecks[wk]){
        s.weeklyChecks[wk] = { items: s.weekTemplateTitles.map(t => ({ id: uuid(), title: t, done:false })) };
      }
      s.recommendTemplates = s.recommendTemplates || [
        { id: uuid(), title:'í¬ë¡œí‚¤ 2ì¥', category:'ê·¸ë¦¼', plannedXp:35, hint:'ì£¼ 3~5íšŒ' },
        { id: uuid(), title:'ìœ ì‚°ì†Œ 40ë¶„', category:'ë‹¤ì´ì–´íŠ¸', plannedXp:40 },
        { id: uuid(), title:'ì˜ë‹¨ì–´ 30ë¶„', category:'ì˜ì–´', plannedXp:25 },
        { id: uuid(), title:'C ê°•ì˜ 1ê°•', category:'ì½”ë”©/ìê²©ì¦', plannedXp:30 },
        { id: uuid(), title:'ë…ì„œ 30ìª½', category:'ìƒí™œ êµì–‘', plannedXp:20 },
      ];
      s.undoSnapshots = s.undoSnapshots || {};
      s.ui = s.ui || { levelChoicesRemaining: 0, showLevelModal: false };
      s.weekRewardGiven = s.weekRewardGiven || {};
      return s;
    }

    function useSfx(enabled, volume){
      const sounds = React.useMemo(()=> ({
        click: new Audio("./click.wav"),
        success: new Audio("./success.wav"),
        fail: new Audio("./fail.wav"),
      }), []);
      React.useEffect(()=> { Object.values(sounds).forEach(a => a.volume = volume); }, [volume]);
      const play = React.useCallback((name) => {
        if(!enabled) return;
        const a = sounds[name];
        if(a){ try { a.currentTime = 0; a.play(); } catch(e){} }
      }, [enabled, sounds]);
      return play;
    }

    function ProgressBar({value}){
      return html`<div className="h-2 bg-slate-200 rounded-xl overflow-hidden"><div className="h-full bg-slate-900" style=${{width: (Math.round((value||0)*100)) + '%'}} /></div>`;
    }
    function Tabs({tabs}){
      const [active, setActive] = React.useState(tabs[0] && tabs[0].key);
      return html`
        <div className="w-full">
          <div className="grid grid-cols-6 border rounded-xl overflow-hidden">
            ${tabs.map(t => html`<button key=${t.key} className=${"px-3 py-2 text-sm " + (active===t.key? 'bg-slate-900 text-white':'bg-white hover:bg-slate-50')} onClick=${() => setActive(t.key)}>${t.label}</button>`)}
          </div>
          <div className="mt-4 card p-4">${(tabs.find(t=>t.key===active)||{}).content}</div>
        </div>`;
    }

    function useWeeklyChecklist(state, setState, selectedDate){
      const weekKey = weekStartFromAnchor(state.settings.weekAnchorDate, selectedDate);
      const checklist = state.weeklyChecks[weekKey] ? JSON.parse(JSON.stringify(state.weeklyChecks[weekKey])) : null;
      const ensureWeek = () => {
        if(!state.weeklyChecks[weekKey]){
          setState(p => {
            const items = (p.weekTemplateTitles||[]).map(t => ({ id: uuid(), title:t, done:false }));
            return {...p, weeklyChecks: {...p.weeklyChecks, [weekKey]: { items }}};
          });
        }
      };
      React.useEffect(ensureWeek, [weekKey, state.settings.weekAnchorDate]);
      const updateChecklist = (updater) => {
        setState(p => {
          const current = p.weeklyChecks[weekKey] || { items: [] };
          const next = updater(current);
          return {...p, weeklyChecks: {...p.weeklyChecks, [weekKey]: next}};
        });
      };
      const setTitlesAsTemplate = (items) => setState(p => ({...p, weekTemplateTitles: items.map(i => i.title)}));
      return { weekKey, checklist, updateChecklist, setTitlesAsTemplate };
    }

    function CategoriesManager({state, setState}){
      function renameCategory(oldName, newName){
        if(!newName || state.categories.includes(newName)) return;
        setState(prev => {
          const cats = prev.categories.map(c => c===oldName? newName : c);
          const newDays = {};
          Object.entries(prev.days).forEach(([k, d]) => {
            const missions = (d.missions||[]).map(m => m.category===oldName? {...m, category:newName} : m);
            newDays[k] = {...d, missions};
          });
          return {...prev, categories: cats, days: newDays};
        });
      }
      function deleteCategory(target){
        if(target==='ê¸°íƒ€') { alert('â€œê¸°íƒ€â€ëŠ” ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
        setState(prev => {
          const cats = prev.categories.filter(c => c!==target);
          if(!cats.includes('ê¸°íƒ€')) cats.push('ê¸°íƒ€');
          const newDays = {};
          Object.entries(prev.days).forEach(([k, d]) => {
            const missions = (d.missions||[]).map(m => m.category===target? {...m, category:'ê¸°íƒ€'} : m);
            newDays[k] = {...d, missions};
          });
          return {...prev, categories: cats, days: newDays};
        });
      }
      function addCategory(){
        let base = 'ìƒˆ ì¹´í…Œê³ ë¦¬'; let name = base, i=1;
        while(state.categories.includes(name)){ i+=1; name = base + ' ' + i; }
        setState(prev => ({...prev, categories: [...prev.categories, name]}));
      }
      return html`<div className="space-y-2">
        ${state.categories.map((c, idx) => html`
          <div key=${idx} className="border rounded-xl p-3 flex items-center gap-2">
            <input className="input flex-1" value=${c} onChange=${e => {
              const v = e.target.value.trim();
              setState(prev => {
                const cats = prev.categories.slice();
                cats[idx] = v || cats[idx];
                return {...prev, categories: cats};
              });
            }} />
            <button className="btn" onClick=${() => {
              const v = prompt('ìƒˆ ì´ë¦„ìœ¼ë¡œ ë°”ê¾¸ê¸°', state.categories[idx]);
              if(v && v.trim() && !state.categories.includes(v.trim())){
                renameCategory(state.categories[idx], v.trim());
              }
            }}>ì´ë¦„ ë³€ê²½</button>
            <button className="btn btn-ghost" disabled=${c==='ê¸°íƒ€'} onClick=${() => deleteCategory(c)}>ğŸ—‘ï¸ ì‚­ì œ</button>
          </div>
        `)}
        <button className="btn" onClick=${addCategory}>â• ì¹´í…Œê³ ë¦¬ ì¶”ê°€</button>
      </div>`;
    }

    function ItemsManager({state, setState}){
      function updateDef(id, patch){
        setState(prev => {
          const defs = prev.itemDefs.map(d => d.id===id? {...d, ...patch} : d);
          const inv = JSON.parse(JSON.stringify(prev.inventory));
          normalizeInventory(inv, defs);
          autoCombineFragments(inv, defs);
          return {...prev, itemDefs: defs, inventory: inv};
        });
      }
      function renameDef(id, newName){
        setState(prev => {
          const old = prev.itemDefs.find(d=>d.id===id); if(!old) return prev;
          const defs = prev.itemDefs.map(d => d.id===id? {...d, name:newName} : d);
          const inv = JSON.parse(JSON.stringify(prev.inventory));
          if(old.name!==newName){
            inv.items[newName] = (inv.items[old.name]||0);
            delete inv.items[old.name];
            if(old.hasFragments){
              inv.fragments[newName] = (inv.fragments[old.name]||0);
              delete inv.fragments[old.name];
            }
          }
          normalizeInventory(inv, defs);
          return {...prev, itemDefs: defs, inventory: inv};
        });
      }
      function deleteDef(id){
        setState(prev => {
          const def = prev.itemDefs.find(d=>d.id===id);
          if(!def) return prev;
          const defs = prev.itemDefs.filter(d => d.id!==id);
          const inv = JSON.parse(JSON.stringify(prev.inventory));
          delete inv.items[def.name];
          delete inv.fragments[def.name];
          normalizeInventory(inv, defs);
          return {...prev, itemDefs: defs, inventory: inv};
        });
      }
      function addDef(){
        const d = { id: uuid(), name:'ìƒˆ ì•„ì´í…œ', hasFragments:false, combineCount:0, autoSupply:false, cap:1, description:'' };
        setState(prev => {
          const defs = [...prev.itemDefs, d];
          const inv = JSON.parse(JSON.stringify(prev.inventory));
          inv.items[d.name]=0;
          normalizeInventory(inv, defs);
          return {...prev, itemDefs: defs, inventory: inv};
        });
      }
      return html`<div className="space-y-3">
        <div className="flex items-center justify-between">
          <div className="text-sm font-semibold">ì•„ì´í…œ ê´€ë¦¬</div>
          <button className="btn" onClick=${addDef}>â• ì¶”ê°€</button>
        </div>
        <div className="space-y-2">
          ${state.itemDefs.map(def => html`
            <div key=${def.id} className="border rounded-xl p-3 space-y-2">
              <div className="grid md:grid-cols-3 gap-2">
                <input className="input" value=${def.name} onChange=${e=> renameDef(def.id, e.target.value)} />
                <label className="flex items-center gap-2">
                  <span className="label">ì¡°ê° ë³´ìœ </span>
                  <span className="switch"><input type="checkbox" checked=${!!def.hasFragments} onChange=${e=> updateDef(def.id, {hasFragments: e.target.checked})} /><span></span></span>
                </label>
                <label className="flex items-center gap-2">
                  <span className="label">ìë™ ë³´ê¸‰</span>
                  <span className="switch"><input type="checkbox" checked=${!!def.autoSupply} onChange=${e=> updateDef(def.id, {autoSupply: e.target.checked})} /><span></span></span>
                </label>
              </div>
              <div className="grid md:grid-cols-3 gap-2 items-end">
                <div>
                  <div className="label">í•©ì„± í•„ìš” ì¡°ê° ìˆ˜</div>
                  <input className="input" type="number" value=${def.combineCount||0} onChange=${e=> updateDef(def.id, {combineCount: Math.max(0, Number(e.target.value)||0)})} />
                </div>
                <div>
                  <div className="label">ìµœëŒ€ ë³´ìœ (cap) â€” ë¹ˆì¹¸=ë¬´ì œí•œ</div>
                  <input className="input" placeholder="" value=${(typeof def.cap==='number')? def.cap : ''} onChange=${e=> {
                    const v = e.target.value.trim();
                    updateDef(def.id, { cap: v===''? null : Math.max(0, Number(v)||0) });
                  }} />
                </div>
                <div className="text-right">
                  <button className="btn btn-ghost" onClick=${() => deleteDef(def.id)}>ğŸ—‘ï¸ ì‚­ì œ</button>
                </div>
              </div>
              <textarea className="input" rows="2" placeholder="ì„¤ëª…" value=${def.description||''} onChange=${e=> updateDef(def.id, {description: e.target.value})}></textarea>
              <div className="text-xs text-slate-500">ì¸ë²¤í† ë¦¬: ì™„ì„± ${state.inventory.items[def.name]||0}ê°œ${def.hasFragments? ` Â· ì¡°ê° ${state.inventory.fragments[def.name]||0}ê°œ` : ''}</div>
            </div>
          `)}
        </div>
      </div>`;
    }

    function AvatarStatic({state, setState}){
      const ports = Array.from({length: 50}, (_,i) => 'port' + (i+1));
      const Chooser = (slot) => html`
        <div className="border rounded-xl p-2 space-y-2">
          <div className="avatar-sm mx-auto">
            <img src=${'./avatars/' + slot + '.png'} alt=${slot}
                 onError=${(e) => { e.target.closest('div.border').style.display='none'; }} />
          </div>
          <div className="flex justify-center">
            <button className="btn" onClick=${() => setState(p=> ({...p, profile:{...p.profile, avatarKind:'static', avatarKey: slot}}))}>ì„ íƒ</button>
          </div>
        </div>`;
      return html`<div className="space-y-2">
        <div className="text-sm text-slate-600">ë¦¬í¬ì§€í„°ë¦¬ì˜ <code>/avatars/port*.png</code>ë¥¼ ìë™ìœ¼ë¡œ í‘œì‹œí•©ë‹ˆë‹¤. ì—†ëŠ” ìŠ¬ë¡¯ì€ ìˆ¨ê²¨ì ¸ìš”.</div>
        <div className="grid grid-cols-3 md:grid-cols-6 gap-3">
          ${ports.map(Chooser)}
        </div>
      </div>`;
    }

    function AvatarUpload({state, setState}){
      const slots = Array.from({length:10}, (_,i) => 'portUpload' + (i+1));
      function onUpload(slot, file){
        const reader = new FileReader();
        reader.onload = () => {
          const dataUrl = String(reader.result);
          setState(prev => ({
            ...prev,
            avatars: {...prev.avatars, [slot]: dataUrl},
            profile: {...prev.profile, avatarKind:'upload', avatarKey: slot }
          }));
        };
        reader.readAsDataURL(file);
      }
      function onDelete(slot){
        setState(prev => {
          const avatars = {...prev.avatars}; delete avatars[slot];
          return {...prev, avatars};
        });
      }
      return html`<div className="space-y-2">
        <div className="text-sm text-slate-600">ë‚´ ì»´í“¨í„°ì—ì„œ ì—…ë¡œë“œí•˜ì—¬ ì´ ê¸°ê¸°ì—ì„œë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.</div>
        <div className="grid grid-cols-3 md:grid-cols-6 gap-3">
          ${slots.map(slot => {
            const img = state.avatars[slot];
            const isActive = state.profile.avatarKind==='upload' && state.profile.avatarKey===slot;
            return html`
              <div key=${slot} className={"border rounded-xl p-2 space-y-2 " + (isActive? "ring-2 ring-slate-900":"")}>
                <div className="avatar-sm mx-auto">
                  ${img ? html`<img src=${img} alt=${slot} />` : html`<div className="text-xs text-slate-500">ë¹ˆ ìŠ¬ë¡¯</div>`}
                </div>
                <div className="flex items-center justify-center gap-2">
                  <label className="btn cursor-pointer">ì—…ë¡œë“œ
                    <input type="file" accept="image/*" className="hidden" onChange=${e=>{
                      const f = e.target.files && e.target.files[0];
                      if(f) onUpload(slot, f);
                    }} />
                  </label>
                  <button className="btn" disabled=${!img} onClick=${() => setState(p=> ({...p, profile:{...p.profile, avatarKind:'upload', avatarKey: slot}}))}>ì„ íƒ</button>
                  <button className="btn btn-ghost" disabled=${!img} onClick=${() => onDelete(slot)}>ğŸ—‘ï¸</button>
                </div>
              </div>`;
          })}
        </div>
      </div>`;
    }

    function Missions({day, state, setState, selectedDate, playSfx}){
      function updateMission(id, patch){
        setState(prev=> ({...prev, days:{...prev.days, [selectedDate]: {...day, missions: day.missions.map(m=> m.id===id? Object.assign({}, m, patch): m) }}}));
      }
      return html`<div className="space-y-3">
        ${day.missions.length===0 && html`<div className="text-sm text-slate-500">ë¯¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤. ì•„ë˜ ë²„íŠ¼ìœ¼ë¡œ ì¶”ê°€í•´ ë³´ì„¸ìš”.</div>`}
        ${day.missions.map(m => html`
          <div key=${m.id} className="border rounded-xl p-3 grid md:grid-cols-12 gap-2 items-center">
            <div className="md:col-span-4">
              <input className="input" aria-label="ë¯¸ì…˜ ì œëª©" value=${m.title} onChange=${e=> updateMission(m.id, {title:e.target.value})} />
            </div>
            <div className="md:col-span-3">
              <select className="input" value=${m.category} onChange=${e=> updateMission(m.id, {category:e.target.value})}>
                ${state.categories.map(c => html`<option key=${c} value=${c}>${c}</option>`)}
              </select>
            </div>
            <div className="md:col-span-3">
              <div className="label">ì˜ˆì • XP</div>
              <input className="input" type="number" value=${m.plannedXp} onChange=${e=> updateMission(m.id, {plannedXp:Number(e.target.value)})} />
            </div>
            <div className="md:col-span-2 flex items-center justify-end gap-2">
              <button className=${"btn " + (m.done? 'btn-primary':'')} onClick=${() => { updateMission(m.id, {done: !m.done}); playSfx('click'); }}>${m.done? 'âœ… ì™„ë£Œ':'â€¦ ë¯¸ì™„ë£Œ'}</button>
              <button className="btn btn-ghost" onClick=${() => setState(prev=> ({...prev, days:{...prev.days, [selectedDate]: {...day, missions: day.missions.filter(x=>x.id!==m.id) }}}))}>ğŸ—‘ï¸</button>
            </div>
          </div>
        `)}
        <div className="flex gap-2">
          <button className="btn" onClick=${() => setState(prev=> ({...prev, days:{...prev.days, [selectedDate]: {...day, missions:[...day.missions, { id: uuid(), title:'ìƒˆ ë¯¸ì…˜', category: state.categories[0]||'ê¸°íƒ€', plannedXp:20, done:false }] }}}))}>â• ìƒˆ ë¯¸ì…˜ ë§Œë“¤ê¸°</button>
        </div>
      </div>`;
    }

    function InventoryPanel({state, setState}){
      const defs = state.itemDefs;
      return html`<div className="grid md:grid-cols-2 gap-4">
        <div className="card p-4">
          <div className="text-base font-semibold mb-2">ğŸ² ì¡°ê°</div>
          <div className="space-y-2">
            ${defs.filter(d=>d.hasFragments).map(d => html`
              <div key=${d.id} className="flex items-center justify-between">
                <div>${d.name}</div>
                <div className="flex items-center gap-2">
                  <span className="px-2 py-1 rounded-xl bg-slate-100">${state.inventory.fragments[d.name]||0}ê°œ</span>
                  <button className="btn" onClick=${() => {
                    setState(p => {
                      const inv = JSON.parse(JSON.stringify(p.inventory));
                      inv.fragments[d.name] = (inv.fragments[d.name]||0) + 1;
                      autoCombineFragments(inv, p.itemDefs);
                      return {...p, inventory: inv};
                    });
                  }}>+1</button>
                </div>
              </div>
            `)}
          </div>
        </div>
        <div className="card p-4">
          <div className="text-base font-semibold mb-2">âœ¨ ì™„ì„± ì•„ì´í…œ</div>
          <div className="space-y-2">
            ${defs.map(d => html`
              <div key=${d.id} className="flex items-center justify-between">
                <div>${d.name}</div>
                <div className="flex items-center gap-2">
                  <span className="px-2 py-1 rounded-xl bg-slate-100">${state.inventory.items[d.name]||0}ê°œ</span>
                  ${d.name==='ì„±ì‹¤ ë°©ì–´ë§‰' ? html`` : html`<button className="btn" onClick=${() => {
                    setState(p => {
                      const inv = JSON.parse(JSON.stringify(p.inventory));
                      addItemWithCap(inv, p.itemDefs, d.name, -1);
                      return {...p, inventory: inv};
                    });
                  }}>-1</button>`}
                </div>
              </div>
            `)}
          </div>
          <div className="text-xs text-slate-600 mt-2">* ê° ì•„ì´í…œì˜ ìº¡/í•©ì„± ê·œì¹™ì€ ì„¤ì • â†’ ì•„ì´í…œ ê´€ë¦¬ì—ì„œ ë°”ê¿€ ìˆ˜ ìˆì–´ìš”.</div>
        </div>
      </div>`;
    }

    function RecommendedTab({state, setState, onAdd}){
      return html`<div className="space-y-3">
        <div className="flex items-center justify-between">
          <div className="text-base font-semibold">âœ¨ ì¶”ì²œ ë¯¸ì…˜</div>
          <button className="btn" onClick=${() => setState(p => ({...p, recommendTemplates:[...p.recommendTemplates, { id: uuid(), title:'ìƒˆ ì¶”ì²œ', category: p.categories[0]||'ê¸°íƒ€', plannedXp:20 }]}))}>â• ì¶”ê°€</button>
        </div>
        <div className="grid md:grid-cols-2 gap-3">
          ${state.recommendTemplates.map((t,i) => html`
            <div key=${t.id} className="card p-4 space-y-2">
              <div className="grid grid-cols-2 gap-2">
                <input className="input" value=${t.title} onChange=${e=> setState(p => ({...p, recommendTemplates: p.recommendTemplates.map(x => x.id===t.id? {...x, title:e.target.value}: x)}))} />
                <select className="input" value=${t.category} onChange=${e=> setState(p => ({...p, recommendTemplates: p.recommendTemplates.map(x => x.id===t.id? {...x, category:e.target.value}: x)}))}>
                  ${state.categories.map(c => html`<option key=${c} value=${c}>${c}</option>`)}
                </select>
                <input className="input" type="number" value=${t.plannedXp||0} onChange=${e=> setState(p => ({...p, recommendTemplates: p.recommendTemplates.map(x => x.id===t.id? {...x, plannedXp:Number(e.target.value)||0}: x)}))} />
              </div>
              <div className="flex items-center justify-between">
                <input className="input" placeholder="íŒíŠ¸(ì„ íƒ)" value=${t.hint||''} onChange=${e=> setState(p => ({...p, recommendTemplates: p.recommendTemplates.map(x => x.id===t.id? {...x, hint:e.target.value}: x)}))} />
                <div className="flex gap-2">
                  <button className="btn btn-primary" onClick=${() => onAdd(t)}>ë‹´ê¸°</button>
                  <button className="btn btn-ghost" onClick=${() => setState(p => ({...p, recommendTemplates: p.recommendTemplates.filter(x => x.id!==t.id)}))}>ğŸ—‘ï¸</button>
                </div>
              </div>
            </div>
          `)}
        </div>
      </div>`;
    }

    function ReportTab({state, addDays}){
      const keys = Object.keys(state.weeklyChecks).sort();
      if(keys.length===0) return html`<div className="text-sm text-slate-500">ì•„ì§ ë¦¬í¬íŠ¸ê°€ ì—†ì–´ìš”.</div>`;
      const rows = keys.map(weekKey => {
        const items = state.weeklyChecks[weekKey].items || [];
        const total = items.length || 1;
        const done = items.filter(i=>i.done).length;
        const pct = Math.round(done/total*100);
        const num = weekIndexFromAnchor(state.settings.weekAnchorDate, weekKey);
        return { weekKey, items, total, done, pct, num };
      });
      function DayRow({dateStr}){
        const d = state.days[dateStr];
        const missions = (d && d.missions) ? d.missions : [];
        const ok = missions.filter(m=>m.done);
        const fail = missions.filter(m=>!m.done);
        return html`<tr>
          <td className="py-1 pr-3">${dateStr}</td>
          <td className="py-1 pr-3">${ok.map(m=>m.title).join(', ') || 'â€”'}</td>
          <td className="py-1 pr-3">${fail.map(m=>m.title).join(', ') || 'â€”'}</td>
        </tr>`;
      }
      return html`<div className="space-y-4">
        <div className="text-base font-semibold">ğŸ“Š ì£¼ê°„ ëª©í‘œ ë¦¬í¬íŠ¸</div>

        <!-- Mobile: each goal per line -->
        <div className="md:hidden space-y-3">
          ${rows.map(r => html`
            <div key=${r.weekKey} className="card p-3">
              <div className="text-sm font-semibold mb-1">${r.num}ì£¼ì°¨ Â· ${r.weekKey}</div>
              <div className="flex items-center gap-2 mb-2">
                <div className="flex-1">${ProgressBar({ value: r.done/r.total })}</div>
                <div className="w-10 text-right text-sm">${r.pct}%</div>
              </div>
              <div className="space-y-1">
                ${r.items.map(i => html`<div className=${"block w-full px-2 py-1 rounded-xl border break-words " + (i.done? 'border-emerald-300 bg-emerald-50':'border-slate-200 bg-slate-50')}>${i.done? 'âœ…':'â¬œï¸'} ${i.title}</div>`)}
              </div>
              <details className="mt-2">
                <summary className="text-xs text-slate-500 cursor-pointer">ì¼ìë³„ ë³´ê¸°</summary>
                <div className="mt-2 card p-3">
                  <div className="overflow-x-auto">
                    <table className="w-full text-xs">
                      <thead><tr className="text-left border-b">
                        <th className="py-1 pr-3">ë‚ ì§œ</th><th className="py-1 pr-3">ë‹¬ì„±</th><th className="py-1 pr-3">ë¯¸ë‹¬ì„±</th>
                      </tr></thead>
                      <tbody>
                        ${[0,1,2,3,4,5,6].map(i => DayRow({dateStr: addDays(r.weekKey, i)}))}
                      </tbody>
                    </table>
                  </div>
                </div>
              </details>
            </div>
          `)}
        </div>

        <!-- Desktop: table -->
        <div className="hidden md:block overflow-x-auto">
          <table className="w-full text-sm">
            <thead><tr className="text-left border-b">
              <th className="py-2 pr-3">ì£¼ì°¨ Â· ì£¼ ì‹œì‘ì¼</th>
              <th className="py-2 pr-3">ë‹¬ì„±ë¥ </th>
              <th className="py-2 pr-3">ëª©í‘œ ëª©ë¡</th>
            </tr></thead>
            <tbody>
              ${rows.map(r => html`
                <tr key=${r.weekKey} className="border-b last:border-0 align-top">
                  <td className="py-2 pr-3 font-medium">${r.num}ì£¼ì°¨ Â· ${r.weekKey}</td>
                  <td className="py-2 pr-3" style=${{minWidth:'160px'}}>
                    <div className="flex items-center gap-2">
                      <div className="w-40">${ProgressBar({ value: r.done/r.total })}</div>
                      <div className="w-10 text-right">${r.pct}%</div>
                    </div>
                    <details className="mt-2">
                      <summary className="text-xs text-slate-500 cursor-pointer">ì¼ìë³„ ë³´ê¸°</summary>
                      <div className="mt-2 card p-3">
                        <div className="overflow-x-auto">
                          <table className="w-full text-xs">
                            <thead><tr className="text-left border-b">
                              <th className="py-1 pr-3">ë‚ ì§œ</th><th className="py-1 pr-3">ë‹¬ì„±</th><th className="py-1 pr-3">ë¯¸ë‹¬ì„±</th>
                            </tr></thead>
                            <tbody>
                              ${[0,1,2,3,4,5,6].map(i => DayRow({dateStr: addDays(r.weekKey, i)}))}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </details>
                  </td>
                  <td className="py-2 pr-3">
                    ${r.items.map(i => html`<div className=${"block w-full px-2 py-1 mb-1 rounded-xl border break-words " + (i.done? 'border-emerald-300 bg-emerald-50':'border-slate-200 bg-slate-50')}>${i.done? 'âœ…':'â¬œï¸'} ${i.title}</div>`)}
                  </td>
                </tr>
              `)}
            </tbody>
          </table>
        </div>
      </div>`;
    }

    function LevelRewardModal({state, setState}){
      const defs = state.itemDefs;
      const remaining = state.ui.levelChoicesRemaining || 0;
      const options = defs.filter(d => {
        const cap = (typeof d.cap==='number') ? d.cap : Infinity;
        const cur = state.inventory.items[d.name]||0;
        return cur < cap;
      });
      function pick(name){
        setState(p => {
          const inv = JSON.parse(JSON.stringify(p.inventory));
          addItemWithCap(inv, p.itemDefs, name, 1);
          const left = Math.max(0, (p.ui.levelChoicesRemaining||0) - 1);
          const willReopen = left > 0;
          setTimeout(() => {
            if(willReopen){
              setState(q => ({...q, ui:{...q.ui, showLevelModal:true, levelChoicesRemaining:left}}));
            }
          }, 200);
          return {...p, inventory: inv, ui:{...p.ui, levelChoicesRemaining: left, showLevelModal: false }};
        });
      }
      return html`<div className="modal">
        <div className="bg-white rounded-2xl p-4 max-w-lg w-full">
          <div className="text-lg font-semibold mb-2">ğŸ ë³´ìƒ ì„ íƒ (${remaining}íšŒ ë‚¨ìŒ)</div>
          ${options.length===0 ? html`<div className="text-sm text-slate-600">ë°›ì„ ìˆ˜ ìˆëŠ” ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤(ëª¨ë‘ ìº¡ ë„ë‹¬).</div>` : html`
            <div className="grid grid-cols-2 gap-2 max-h-[50vh] overflow-auto">
              ${options.map(o => html`<button key=${o.id} className="btn" onClick=${() => pick(o.name)}>${o.name} ë°›ê¸°</button>`)}
            </div>`}
          <div className="flex justify-end gap-2 mt-3">
            <button className="btn btn-ghost" onClick=${() => setState(p => ({...p, ui:{...p.ui, showLevelModal:false}}))}>ë‹«ê¸°</button>
          </div>
        </div>
      </div>`;
    }

    function SettingsTab({state, setState}){
      const s = state.settings;
      return html`<div className="grid gap-4">
        <div className="border rounded-xl p-3 space-y-3">
          <div className="text-base font-semibold">ğŸ–¼ï¸ ì•„ë°”íƒ€</div>
          <div className="grid gap-4">
            <div className="card p-3">
              <div className="text-sm font-semibold mb-2">ë ˆí¬ í¬í•¨(ì •ì )</div>
              ${html`<${AvatarStatic} state=${state} setState=${setState} />`}
            </div>
            <div className="card p-3">
              <div className="text-sm font-semibold mb-2">ë‚´ ì»´í“¨í„°ì—ì„œ ì—…ë¡œë“œ</div>
              ${html`<${AvatarUpload} state=${state} setState=${setState} />`}
            </div>
          </div>

          <div className="text-base font-semibold mt-6">âš™ï¸ ì£¼ì°¨ ê´€ë¦¬</div>
          <div className="grid grid-cols-2 gap-2 items-end">
            <div>
              <div className="label">ì£¼ì°¨ ì‹œì‘ì¼(ì•µì»¤) â€” ì´ ë‚ ì´ 1ì£¼ì°¨ ì‹œì‘</div>
              <input type="date" className="input" value=${s.weekAnchorDate} onChange=${e => {
                const val = e.target.value;
                setState(p => ({...p, settings:{...p.settings, weekAnchorDate: val }}));
              }} />
            </div>
            <label className="flex items-center gap-2">
              <span className="label">ì£¼ì°¨ ìë™ ê³„ì‚°</span>
              <span className="switch"><input type="checkbox" checked=${!!s.autoWeek} onChange=${e=> setState(p=> ({...p, settings:{...p.settings, autoWeek: e.target.checked}}))} /><span></span></span>
            </label>
          </div>
          <div className="text-xs text-slate-500">* ì•µì»¤ ë‚ ì§œ ê¸°ì¤€ 7ì¼ë§ˆë‹¤ ì£¼ì°¨ê°€ ìë™ ì¦ê°€í•©ë‹ˆë‹¤.</div>

          <div className="border-t pt-3 space-y-2">
            <div className="text-sm font-semibold">ğŸ“¦ 2ì£¼ ë³´ê¸‰</div>
            <div className="grid grid-cols-2 gap-2 items-end">
              <div>
                <div className="label">ë³´ê¸‰ ì•µì»¤ ë‚ ì§œ</div>
                <input type="date" className="input" value=${s.supplyAnchorDate} onChange=${e => {
                  const val = e.target.value;
                  setState(p => ({...p, settings:{...p.settings, supplyAnchorDate: val }}));
                }} />
              </div>
              <button className="btn" onClick=${() => window.__settleSupply && window.__settleSupply()}>ì§€ê¸ˆ ë³´ê¸‰ ì •ì‚°</button>
            </div>
            <div className="text-xs text-slate-500">* **ìë™ ë³´ê¸‰**ì´ ì¼œì§„ ì•„ì´í…œë§Œ ê° +1 ì§€ê¸‰ë¼ìš”.</div>
          </div>

          <div className="border-t pt-3 space-y-2">
            <div className="text-sm font-semibold">ğŸ·ï¸ ì¹´í…Œê³ ë¦¬ ê´€ë¦¬</div>
            ${html`<${CategoriesManager} state=${state} setState=${setState} />`}
          </div>

          <div className="border-t pt-3">
            ${html`<${ItemsManager} state=${state} setState=${setState} />`}
          </div>
        </div>

        <div className="border rounded-xl p-3 space-y-3">
          <div className="text-sm font-medium">ë¹ ë¥¸ ë©”ëª¨</div>
          <textarea className="input" rows="8" placeholder="ê·¸ë‚ ì˜ ì»¨ë””ì…˜, ê¹¨ë‹¬ìŒ, íšŒê³  ë“±ì„ ê¸°ë¡í•˜ì„¸ìš”." value=${state.quickNote||''} onChange=${e=> setState(p=> ({...p, quickNote: e.target.value}))}></textarea>
        </div>
      </div>`;
    }

    function App(){
      const [state, setState] = React.useState(() => {
        const raw = localStorage.getItem(LS_KEY);
        const s = raw ? JSON.parse(raw) : null;
        return migrateState(s);
      });
      const [selectedDate, setSelectedDate] = React.useState(todayStr);
      React.useEffect(() => { localStorage.setItem(LS_KEY, JSON.stringify(state)); }, [state]);

      const playSfx = useSfx(state.settings.sfx, state.settings.sfxVolume);

      // Avatar persistence guard
      React.useEffect(() => {
        if(!state.profile.avatarKind){ setState(p=> ({...p, profile:{...p.profile, avatarKind:'static'}})); }
        if(!state.profile.avatarKey){ setState(p=> ({...p, profile:{...p.profile, avatarKey:'port1'}})); }
      }, [state.profile.avatarKind, state.profile.avatarKey]);

      const day = React.useMemo(() => state.days[selectedDate] || { date:selectedDate, missions:[], settled:false, dayXpAwarded:0, shieldUsed:false }, [state, selectedDate]);
      React.useEffect(() => {
        if(!state.days[selectedDate]){
          const prevDate = addDays(selectedDate, -1);
          const prev = state.days[prevDate];
          const carried = prev && Array.isArray(prev.missions) && prev.missions.length>0
            ? prev.missions.map(m => ({...m, id: uuid(), done:false}))
            : [];
          setState(prevState => ({...prevState, days:{...prevState.days, [selectedDate]: { date:selectedDate, missions: carried, settled:false, dayXpAwarded:0, shieldUsed:false }}}));
        }
      }, [selectedDate]);

      const { weekKey, checklist, updateChecklist } = useWeeklyChecklist(state, setState, selectedDate);
      const wkItems = checklist ? checklist.items : [];
      const weekPct = (wkItems.filter(i=>i.done).length) / (wkItems.length||1);

      function settleSupply(nowStr){
        const diffDays = Math.floor((new Date(nowStr+'T00:00:00') - new Date(state.settings.supplyAnchorDate+'T00:00:00'))/DAY_MS);
        const elapsedPeriods = Math.max(0, Math.floor(diffDays / 14));
        if(elapsedPeriods > state.settings.supplyGivenPeriods){
          let times = elapsedPeriods - state.settings.supplyGivenPeriods;
          const inv = JSON.parse(JSON.stringify(state.inventory));
          while(times-- > 0){
            state.itemDefs.forEach(def => { if(def.autoSupply){ addItemWithCap(inv, state.itemDefs, def.name, 1); } });
          }
          setState(p => ({...p, inventory: inv, settings:{...p.settings, supplyGivenPeriods: elapsedPeriods }}));
        }
      }
      window.__settleSupply = () => settleSupply(selectedDate);
      React.useEffect(() => { settleSupply(selectedDate); }, [selectedDate, state.settings.supplyAnchorDate, state.itemDefs]);

      function xpForMission(m, rates){
        const base = Number(m.plannedXp)||0;
        const extra = m.isExtra ? base * (state.settings.extraMissionRate||0.6) : base;
        return m.done ? extra : base * (rates.xpPenaltyRate||0.5);
      }
      function settleDay(){
        const s = state; const d = day; if(d.settled) return;
        const snapshot = { profile: s.profile, inventory: s.inventory, day: d, ui: s.ui, weekRewardGiven: s.weekRewardGiven };
        const rates = { xpPenaltyRate: d.shieldUsed ? 1.0 : s.settings.xpPenaltyRate, extraMissionRate: s.settings.extraMissionRate };
        const awarded = Math.round(d.missions.reduce((acc,m)=> acc + xpForMission(m, rates), 0));
        let level = s.profile.level, xp = s.profile.xp + awarded, next = s.profile.nextLevelXp, levelsGained = 0;
        while(xp >= next){ xp -= next; level += 1; levelsGained += 1; next = Math.round(next * 1.25); }

        // weekly all-clear on week rollover
        const curWeekIdx = weekIndexFromAnchor(s.settings.weekAnchorDate, d.date);
        const nextDate = addDays(d.date, 1);
        const nextWeekIdx = weekIndexFromAnchor(s.settings.weekAnchorDate, nextDate);
        let weeklyBonus = 0;
        if(nextWeekIdx > curWeekIdx){
          const thisWeekKey = weekStartFromAnchor(s.settings.weekAnchorDate, d.date);
          const wk = s.weeklyChecks[thisWeekKey];
          const allClear = wk && (wk.items||[]).length>0 && (wk.items.every(it => !!it.done));
          const already = !!s.weekRewardGiven[thisWeekKey];
          if(allClear && !already){
            weeklyBonus = 1;
          }
        }

        const completionRate = (d.missions.filter(m=>m.done).length) / (d.missions.length || 1);
        const chance = percent(clamp01(completionRate * 1.2));
        const success = Math.random()*100 < chance;
        const inv = JSON.parse(JSON.stringify(s.inventory));
        let rewardText='';
        if(success){
          rewardText = 'ë¯¸ë‹ˆë³´ìŠ¤ ìŠ¹ë¦¬!';
        }else{
          if(!d.shieldUsed){
            const candidates = s.itemDefs.map(x=>x.name).filter(k => (inv.items[k]||0) > 0);
            if(candidates.length>0){
              const lossKey = candidates[Math.floor(Math.random()*candidates.length)];
              inv.items[lossKey] = Math.max(0, (inv.items[lossKey]||0)-1);
              rewardText = `íŒ¨ë°° í˜ë„í‹°: ${lossKey} -1`;
            } else rewardText = `íŒ¨ë°°: ìƒì„ ì™„ì„± ì•„ì´í…œ ì—†ìŒ`;
          }else rewardText = `íŒ¨ë°°: ë°©ì–´ë§‰ìœ¼ë¡œ ì†Œë©¸ ë©´ì œ`;
        }

        const picks = (s.ui.levelChoicesRemaining||0) + levelsGained + weeklyBonus;
        const newDay = { ...d, settled:true, dayXpAwarded: awarded, minibossResult: success? 'ì„±ê³µ':'ì‹¤íŒ¨', minibossChance: chance, rewardText };
        setState(prev=> {
          const weekRewardGiven = {...prev.weekRewardGiven};
          if(weeklyBonus){
            const thisWeekKey = weekStartFromAnchor(prev.settings.weekAnchorDate, d.date);
            weekRewardGiven[thisWeekKey] = true;
          }
          return {
            ...prev,
            profile:{level, xp, nextLevelXp:next},
            days:{...prev.days, [selectedDate]: newDay},
            inventory:inv,
            ui:{...prev.ui, levelChoicesRemaining: picks, showLevelModal: picks>0 },
            undoSnapshots:{...prev.undoSnapshots, [selectedDate]: snapshot},
            weekRewardGiven
          };
        });
      }
      function undoSettle(){
        const snap = state.undoSnapshots[selectedDate];
        if(!day.settled || !snap){ alert('ì·¨ì†Œí•  ì •ì‚° ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
        const restoredDay = { ...snap.day, settled:false, dayXpAwarded:0, minibossResult: undefined, minibossChance: undefined, rewardText: undefined };
        const restoredInv = JSON.parse(JSON.stringify(snap.inventory));
        if(snap.day.shieldUsed){ if(restoredInv.items['ì„±ì‹¤ ë°©ì–´ë§‰']!=null) restoredInv.items['ì„±ì‹¤ ë°©ì–´ë§‰'] = (restoredInv.items['ì„±ì‹¤ ë°©ì–´ë§‰']||0) + 1; restoredDay.shieldUsed=false; }
        setState(prev => {
          const nextSnaps = {...prev.undoSnapshots}; delete nextSnaps[selectedDate];
          return {...prev, profile: snap.profile, inventory: restoredInv, days:{...prev.days, [selectedDate]: restoredDay}, ui: snap.ui, undoSnapshots: nextSnaps, weekRewardGiven: snap.weekRewardGiven };
        });
      }

      const avatarSrc = state.profile.avatarKind==='static'
        ? ('./avatars/' + (state.profile.avatarKey||'port1') + '.png')
        : (state.avatars[state.profile.avatarKey] || null);

      const displayWeek = state.settings.autoWeek ? weekIndexFromAnchor(state.settings.weekAnchorDate, selectedDate) : (state.weekNumber || 1);

      // Shield button handler
      function useShield(){
        if(day.settled) return;
        if(day.shieldUsed) return; // already used, do nothing
        const count = (state.inventory.items['ì„±ì‹¤ ë°©ì–´ë§‰']||0);
        if(count <= 0){
          alert('ì„±ì‹¤ ë°©ì–´ë§‰ì´ 0ê°œì…ë‹ˆë‹¤.');
          return;
        }
        setState(prev => {
          const inv = JSON.parse(JSON.stringify(prev.inventory));
          inv.items['ì„±ì‹¤ ë°©ì–´ë§‰'] = (inv.items['ì„±ì‹¤ ë°©ì–´ë§‰']||0) - 1;
          return { ...prev, inventory: inv, days:{...prev.days, [selectedDate]: {...day, shieldUsed:true}} };
        });
      }

      return html`<div className="max-w-6xl mx-auto grid gap-6">
        <div className="flex items-center justify-between gap-3">
          <div className="flex items-center gap-3 flex-wrap">
            <div className="text-2xl">âœ¨</div>
            <h1 className="text-2xl md:text-3xl font-bold">ì„±ì‹¤ ë ˆë²¨ ì—… í”„ë¡œì íŠ¸ (PWA v9.10)</h1>
            <div className="flex items-center gap-2">
              <span className="px-2 py-1 rounded-xl bg-slate-100 text-slate-700 text-sm">ì£¼ì°¨</span>
              <div className="flex items-center gap-2">
                <span className="px-2 py-1 rounded-xl bg-slate-100">${displayWeek}ì£¼ì°¨</span>
                <span className="text-xs text-slate-500">ì•µì»¤: ${state.settings.weekAnchorDate}</span>
              </div>
            </div>
          </div>
          <div className="flex items-center gap-2">
            <button className="btn" onClick=${() => {
              const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
              const url = URL.createObjectURL(blob); const a=document.createElement('a');
              a.href = url; a.download = `ì„±ì‹¤ë ˆë²¨ì—…_${selectedDate}.json`; a.click(); URL.revokeObjectURL(url);
            }}>â¬‡ï¸ ë‚´ë³´ë‚´ê¸°</button>
            <label className="btn cursor-pointer">â¬†ï¸ ê°€ì ¸ì˜¤ê¸°
              <input type="file" accept="application/json" className="hidden" onChange=${e=>{ const f=e.target.files&&e.target.files[0]; if(f){ const r=new FileReader(); r.onload=()=>{ try{ const s=JSON.parse(String(r.result)); localStorage.setItem(LS_KEY, JSON.stringify(s)); location.reload(); }catch{ alert('ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: JSON í˜•ì‹ ì˜¤ë¥˜'); } }; r.readAsText(f);} }}/>
            </label>
          </div>
        </div>

        <div className="grid md:grid-cols-3 gap-4">
          <div className="card p-4">
            <div className="flex items-center gap-3 mb-3">
              <div className="avatar">${avatarSrc ? html`<img src=${avatarSrc} alt="avatar" />` : html`<div className="text-xs text-slate-500">No Avatar</div>`}</div>
              <div>
                <div className="text-xs text-slate-500">í”„ë¡œí•„ ì´ë¯¸ì§€</div>
                <div className="text-sm">ì„¤ì • â†’ ì•„ë°”íƒ€ì—ì„œ ë³€ê²½</div>
              </div>
            </div>
            <div className="text-lg font-semibold mb-3">ğŸ›¡ï¸ í”„ë¡œí•„</div>
            <div className="grid grid-cols-3 gap-3 items-end">
              <div><div className="label">ë ˆë²¨</div><input className="input" type="number" value=${state.profile.level} onChange=${e=> setState(p=>({...p, profile:{...p.profile, level:Number(e.target.value)}}))} /></div>
              <div><div className="label">ê²½í—˜ì¹˜</div><input className="input" type="number" value=${state.profile.xp} onChange=${e=> setState(p=>({...p, profile:{...p.profile, xp:Number(e.target.value)}}))} /></div>
              <div><div className="label">ë‹¤ìŒ ë ˆë²¨ í•„ìš”ì¹˜</div><input className="input" type="number" value=${state.profile.nextLevelXp} onChange=${e=> setState(p=>({...p, profile:{...p.profile, nextLevelXp:Number(e.target.value)}}))} /></div>
            </div>
          </div>

          <div className="card p-4">
            <div className="text-lg font-semibold mb-3">ğŸ“… ì˜¤ëŠ˜</div>
            <div className="grid gap-3">
              <div className="flex items-center gap-2">
                <input className="input" type="date" value=${selectedDate} onChange=${e=> setSelectedDate(e.target.value)} />
                <button className="btn" onClick=${() => setSelectedDate(todayStr)}>ì˜¤ëŠ˜</button>
              </div>
              <div className="flex items-center justify-between"><div className="text-sm text-slate-600">ë‹¬ì„±ë¥ </div><div className="text-lg font-semibold">${percent((day.missions.filter(m=>m.done).length) / (day.missions.length || 1))}%</div></div>
              ${ProgressBar({ value: (day.missions.filter(m=>m.done).length) / (day.missions.length || 1) })}
              <div className="flex items-center justify-between"><div className="text-sm text-slate-600">ë¯¸ë‹ˆë³´ìŠ¤ ìŠ¹ë¥ </div><div className="text-lg font-semibold">${percent(Math.max(0, Math.min(1, (day.missions.filter(m=>m.done).length) / (day.missions.length || 1) * 1.2)))}%</div></div>
              ${day.shieldUsed ? html`<div className="text-sm text-indigo-700 bg-indigo-50 border border-indigo-200 rounded-xl p-2">ì˜¤ëŠ˜ ë°©ì–´ë§‰ ì ìš©ë¨: í˜ë„í‹°/ì†Œë©¸ ë©´ì œ</div>` : html``}
              <div className="grid grid-cols-2 gap-2">
                <button className=${"btn " + (day.shieldUsed ? "btn-primary" : "")} onClick=${useShield}>ğŸ›¡ ì„±ì‹¤ ë°©ì–´ë§‰ ì‚¬ìš©</button>
                ${day.settled ? html`<div className="btn btn-ghost">ì •ì‚° ì™„ë£Œ</div>` : html`<button className="btn btn-primary" onClick=${() => settleDay()}>ğŸ—¡ï¸ í•˜ë£¨ ë Â· ì •ì‚°</button>`}
              </div>
              ${day.settled && html`<div className="grid grid-cols-2 gap-2">
                <button className="btn" onClick=${() => undoSettle()}>â†©ï¸ ì •ì‚° ì·¨ì†Œ</button>
                <div className="text-xs text-slate-600 flex items-center">ë³´ìƒ/ê²°ê³¼: ${day.rewardText||'-'}</div>
              </div>`}
            </div>
          </div>

          <div className="card p-4">
            <div className="text-lg font-semibold mb-3">ğŸ† ì£¼ê°„ ì§„í–‰(ì£¼ê°„ ëª©í‘œ ê¸°ì¤€)</div>
            <div className="space-y-3">
              <div className="text-sm text-slate-600">ì´ë²ˆ ì£¼(${weekKey}~) ì¢…í•©</div>
              ${ProgressBar({ value: weekPct })}
              <div className="text-sm">${Math.round(weekPct*100)}%</div>
              <div className="space-y-2">
                ${(wkItems||[]).map(it => html`
                  <label key=${it.id} className="flex items-center gap-2 border rounded-xl p-2">
                    <input type="checkbox" checked=${!!it.done} onChange=${e=> updateChecklist(cur => ({...cur, items: cur.items.map(x => x.id===it.id? {...x, done:e.target.checked}: x)}))} />
                    <span className="break-words">${it.title}</span>
                  </label>
                `)}
              </div>
              <div className="text-xs text-slate-500">* ì œëª©/êµ¬ì„±ì€ â€œì£¼ê°„ ëª©í‘œ ì„¤ì •â€ íƒ­ì—ì„œ ë°”ê¿€ ìˆ˜ ìˆì–´ìš”.</div>
            </div>
          </div>
        </div>

        ${Tabs({ tabs: [
          { key:'missions', label:'ì˜¤ëŠ˜ì˜ ë¯¸ì…˜', content: Missions({ day, state, setState, selectedDate, playSfx }) },
          { key:'weekly', label:'ì£¼ê°„ ëª©í‘œ ì„¤ì •', content: (function(){ const t = useWeeklyChecklist(state, setState, selectedDate); return (function WeeklySetup(){ const { weekKey, checklist, updateChecklist, setTitlesAsTemplate } = t; if(!checklist) return html`<div className="text-sm text-slate-500">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>`; const items = checklist.items; return html`
            <div className="space-y-4">
              <div className="text-base font-semibold">ğŸ“ ì£¼ê°„ ëª©í‘œ ì„¤ì • (ì²´í¬ëŠ” í™ˆì—ì„œ)</div>
              <div className="space-y-2">
                ${items.map((it, idx) => html`
                  <div key=${it.id} className="border rounded-xl p-3 flex items-center gap-3">
                    <input className="input flex-1" value=${it.title} onChange=${e=> updateChecklist(cur => { const next = { ...cur, items: cur.items.map(x=> x.id===it.id? {...x, title:e.target.value}: x) }; setTitlesAsTemplate(next.items); return next; })} />
                    <button className="btn btn-ghost" onClick=${() => updateChecklist(cur => { const next = { ...cur, items: cur.items.filter(x=> x.id!==it.id) }; setTitlesAsTemplate(next.items); return next; })}>ğŸ—‘ï¸</button>
                  </div>
                `)}
              </div>
              <div className="flex gap-2">
                <button className="btn" onClick=${() => updateChecklist(cur => { const next = { ...cur, items: [...cur.items, { id: uuid(), title:'ìƒˆ ëª©í‘œ', done:false }] }; setTitlesAsTemplate(next.items); return next; })}>â• í•­ëª© ì¶”ê°€</button>
              </div>
              <div className="text-xs text-slate-500">* ì²´í¬/ë‹¬ì„±ì€ í™ˆì˜ â€œì£¼ê°„ ì§„í–‰â€ ì¹´ë“œì—ì„œ í•©ë‹ˆë‹¤.</div>
            </div>`; })() })() },
          { key:'report', label:'ì£¼ì°¨ ë¦¬í¬íŠ¸', content: ReportTab({ state, addDays }) },
          { key:'inventory', label:'ì¸ë²¤í† ë¦¬', content: InventoryPanel({ state, setState }) },
          { key:'recommend', label:'ì¶”ì²œ ë¯¸ì…˜', content: RecommendedTab({ state, setState, onAdd: (t) => setState(prev=> ({...prev, days:{...prev.days, [selectedDate]: {...day, missions:[...day.missions, { id: uuid(), title:t.title, category:t.category, plannedXp:t.plannedXp||0, done:false }] }}})) }) },
          { key:'settings', label:'ì„¤ì •', content: SettingsTab({ state, setState }) },
        ]})}

        ${ (state.ui.showLevelModal && (state.ui.levelChoicesRemaining||0)>0) ? html`<${LevelRewardModal} state=${state} setState=${setState} />` : null }

        <div className="text-center text-xs text-slate-500 py-6">Â© ${new Date().getFullYear()} ì„±ì‹¤ ë ˆë²¨ ì—… í”„ë¡œì íŠ¸ Â· PWA</div>
      </div>`;
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(html`<${App} />`);
  </script>
</body>
</html>