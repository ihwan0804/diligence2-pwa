<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>성실 레벨 업 프로젝트 — PWA (v7: Categories Fix)</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f172a">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/htm@3.1.1/dist/htm.umd.js"></script>
  <style>
    html,body{height:100%}
    .card{ border-radius:1rem; border:1px solid #e2e8f0; background:#fff; box-shadow:0 1px 2px rgba(0,0,0,.04); }
    .btn{ display:inline-flex; align-items:center; justify-content:center; padding:.5rem .75rem; border-radius:.75rem; border:1px solid #cbd5e1; background:#fff; }
    .btn:hover{ background:#f8fafc }
    .btn-primary{ background:#0f172a; color:#fff; border-color:#0f172a }
    .btn-ghost{ border-color:transparent }
    .input{ width:100%; border:1px solid #cbd5e1; border-radius:.75rem; padding:.5rem .75rem }
    .label{ font-size:.75rem; color:#475569 }
  </style>
</head>
<body class="min-h-full bg-gradient-to-b from-slate-50 to-white text-slate-900 p-4 md:p-8">
  <div id="root"></div>

  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./sw.js").catch(()=>{});
      });
    }
  </script>

  <script>
    const html = htm.bind(React.createElement);
    const LS_KEY = 'dlu.v7.categories.fix';
    const fmtDate = d => new Date(d).toISOString().slice(0,10);
    const todayStr = fmtDate(new Date());
    const uuid = () => (window.crypto && crypto.randomUUID ? crypto.randomUUID() : ('id_' + Math.random().toString(36).slice(2)));

    const defaultCategories = ['다이어트','그림','코딩/자격증','영어','생활 교양','책 쓰기','생활 습관','기타'];

    const seedMissions = () => ([
      { id: uuid(), title:'유산소 운동 40분', category:'다이어트', plannedXp:40, done:false },
      { id: uuid(), title:'크로키 2장', category:'그림', plannedXp:35, done:false },
      { id: uuid(), title:'C 강의 1강', category:'코딩/자격증', plannedXp:30, done:false },
      { id: uuid(), title:'영단어 암기 30분', category:'영어', plannedXp:25, done:false },
    ]);

    const save = (s) => localStorage.setItem(LS_KEY, JSON.stringify(s));
    const load = () => { try { const raw = localStorage.getItem(LS_KEY); return raw ? JSON.parse(raw) : null } catch { return null } };

    function migrate(s){
      s = s || {};
      s.categories = Array.isArray(s.categories)&&s.categories.length? s.categories : defaultCategories.slice();
      if(!s.categories.includes('기타')) s.categories.push('기타');
      s.days = s.days || {};
      if(!s.days[todayStr]) s.days[todayStr] = { date: todayStr, missions: seedMissions() };
      return s;
    }

    function App(){
      const [state, setState] = React.useState(() => migrate(load()));

      const [selectedDate, setSelectedDate] = React.useState(todayStr);
      React.useEffect(() => { save(state); }, [state]);

      const day = state.days[selectedDate] || { date:selectedDate, missions:[] };
      React.useEffect(() => {
        if(!state.days[selectedDate]){
          setState(prev => ({...prev, days:{...prev.days, [selectedDate]: { date:selectedDate, missions:[] }}}));
        }
      }, [selectedDate]);

      function CategoriesTab(){
        return html`<div className="space-y-4">
          <div className="text-base font-semibold">🏷️ 카테고리 관리</div>
          <div className="text-xs text-slate-500">* 삭제 시 해당 카테고리의 미션은 “기타”로 이동합니다. “기타”는 항상 유지됩니다.</div>
          <div className="space-y-2">
            ${state.categories.map((c, idx) => html`
              <div key=${idx} className="border rounded-xl p-3 flex items-center gap-2">
                <input className="input flex-1" value=${c} onChange=${e => {
                  const v = e.target.value;
                  setState(prev => {
                    const cats = prev.categories.slice();
                    cats[idx] = v;
                    return {...prev, categories: cats};
                  });
                }} />
                <button className="btn btn-ghost" disabled=${c==='기타'} onClick=${() => {
                  if(!confirm('삭제할까요? 이 카테고리의 미션은 “기타”로 이동합니다.')) return;
                  setState(prev => {
                    const cats = prev.categories.filter(x => x!==c);
                    if(!cats.includes('기타')) cats.push('기타');
                    const days = {};
                    Object.entries(prev.days).forEach(([k,d]) => {
                      const missions = (d.missions||[]).map(m => m.category===c? {...m, category:'기타'} : m);
                      days[k] = {...d, missions};
                    });
                    return {...prev, categories: cats, days};
                  });
                }}>🗑️ 삭제</button>
              </div>
            `)}
          </div>
          <div><button className="btn" onClick=${() => {
            let name='새 카테고리'; let i=1;
            while(state.categories.includes(name)){ i++; name='새 카테고리 '+i; }
            setState(prev => ({...prev, categories:[...prev.categories, name]}));
          }}>➕ 카테고리 추가</button></div>
        </div>`;
      }

      function MissionsTab(){
        return html`<div className="space-y-3">
          ${day.missions.length===0 && html`<div className="text-sm text-slate-500">미션이 없습니다. 아래 버튼으로 추가해 보세요.</div>`}
          ${day.missions.map(m => html`
            <div key=${m.id} className="border rounded-xl p-3 grid md:grid-cols-12 gap-2 items-center">
              <div className="md:col-span-4">
                <input className="input" value=${m.title} onChange=${e => {
                  setState(prev => {
                    const missions = day.missions.map(mm => mm.id===m.id? {...mm, title:e.target.value}: mm);
                    return {...prev, days:{...prev.days, [selectedDate]: {...day, missions}}};
                  });
                }} />
              </div>
              <div className="md:col-span-3">
                <select className="input" value=${m.category} onChange=${e => {
                  setState(prev => {
                    const missions = day.missions.map(mm => mm.id===m.id? {...mm, category:e.target.value}: mm);
                    return {...prev, days:{...prev.days, [selectedDate]: {...day, missions}}};
                  });
                }}>
                  ${state.categories.map(c => html`<option key=${c} value=${c}>${c}</option>`)}
                </select>
              </div>
              <div className="md:col-span-3">
                <input className="input" type="number" value=${m.plannedXp} onChange=${e => {
                  setState(prev => {
                    const missions = day.missions.map(mm => mm.id===m.id? {...mm, plannedXp:Number(e.target.value)||0}: mm);
                    return {...prev, days:{...prev.days, [selectedDate]: {...day, missions}}};
                  });
                }} />
              </div>
              <div className="md:col-span-2 flex justify-end gap-2">
                <button className=${"btn " + (m.done? 'btn-primary':'')} onClick=${() => {
                  setState(prev => {
                    const missions = day.missions.map(mm => mm.id===m.id? {...mm, done:!m.done}: mm);
                    return {...prev, days:{...prev.days, [selectedDate]: {...day, missions}}};
                  });
                }}>${m.done? '✅ 완료':'… 미완료'}</button>
                <button className="btn btn-ghost" onClick=${() => {
                  setState(prev => {
                    const missions = day.missions.filter(mm => mm.id!==m.id);
                    return {...prev, days:{...prev.days, [selectedDate]: {...day, missions}}};
                  });
                }}>🗑️</button>
              </div>
            </div>
          `)}
          <button className="btn" onClick=${() => {
            setState(prev => {
              const missions = [...day.missions, { id: uuid(), title:'새 미션', category: state.categories[0]||'기타', plannedXp:20, done:false }];
              return {...prev, days:{...prev.days, [selectedDate]: {...day, missions}}};
            });
          }}>➕ 새 미션 만들기</button>
        </div>`;
      }

      return html`<div className="max-w-5xl mx-auto grid gap-6">
        <div className="flex items-center justify-between gap-3">
          <h1 className="text-2xl md:text-3xl font-bold">성실 레벨 업 프로젝트 (카테고리)</h1>
          <div className="flex items-center gap-2">
            <input type="date" className="input" value=${selectedDate} onChange=${e=> setSelectedDate(e.target.value)} />
            <button className="btn" onClick=${() => setSelectedDate(todayStr)}>오늘</button>
          </div>
        </div>

        <div className="grid md:grid-cols-2 gap-4">
          <div className="card p-4">
            <div className="text-lg font-semibold mb-3">🏷️ 카테고리</div>
            ${html`<${CategoriesTab} />`}
          </div>
          <div className="card p-4">
            <div className="text-lg font-semibold mb-3">📋 오늘의 미션</div>
            ${html`<${MissionsTab} />`}
          </div>
        </div>

        <div className="text-center text-xs text-slate-500 py-6">© ${new Date().getFullYear()} 성실 레벨 업 프로젝트 · PWA</div>
      </div>`;
    }
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(html`<${App} />`);
  </script>
</body>
</html>