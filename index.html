<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ì„±ì‹¤ ë ˆë²¨ ì—… í”„ë¡œì íŠ¸ â€” PWA (No-Babel)</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f172a">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/htm@3.1.1/dist/htm.umd.js"></script>
  <style>
    html,body{height:100%}
    .card{ border-radius:1rem; border:1px solid #e2e8f0; background:#fff; box-shadow:0 1px 2px rgba(0,0,0,.04); }
    .btn{ display:inline-flex; align-items:center; justify-content:center; padding:.5rem .75rem; border-radius:.75rem; border:1px solid #cbd5e1; background:#fff; }
    .btn:hover{ background:#f8fafc }
    .btn-primary{ background:#0f172a; color:#fff; border-color:#0f172a }
    .btn-ghost{ border-color:transparent }
    .input{ width:100%; border:1px solid #cbd5e1; border-radius:.75rem; padding:.5rem .75rem }
    .label{ font-size:.75rem; color:#475569 }
    .switch{ width:38px; height:22px }
    .switch input{ display:none }
    .switch span{ display:block; width:100%; height:100%; background:#e2e8f0; border-radius:9999px; position:relative; transition:.2s }
    .switch span:after{ content:''; position:absolute; top:2px; left:2px; width:18px; height:18px; background:#fff; border-radius:9999px; transition:.2s; box-shadow:0 1px 2px rgba(0,0,0,.2) }
    .switch input:checked + span{ background:#0f172a }
    .switch input:checked + span:after{ transform:translateX(16px) }
    .pixelate{ image-rendering: pixelated }
  </style>
</head>
<body class="min-h-full bg-gradient-to-b from-slate-50 to-white text-slate-900 p-4 md:p-8">
  <div id="root"></div>

  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./sw.js").catch(()=>{});
      });
    }
  </script>

  <script>
    const html = htm.bind(React.createElement);
    const CATEGORIES = ['ë‹¤ì´ì–´íŠ¸','ê·¸ë¦¼','ì½”ë”©/ìê²©ì¦','ì˜ì–´','ìƒí™œ êµì–‘','ì±… ì“°ê¸°','ìƒí™œ ìŠµê´€'];
    const LS_KEY = 'diligence-level-up-app.v4.nobabel';
    const fmtDate = d => new Date(d).toISOString().slice(0,10);
    const todayStr = fmtDate(new Date());
    const DAY_MS = 24*60*60*1000;
    const clamp01 = x => Math.max(0, Math.min(1, x));
    const percent = n => Math.round(n*100);
    const defaultWeeklyGoals = [
      { category: 'ê·¸ë¦¼', targetCount: 5, achievedCount: 0 },
      { category: 'ì½”ë”©/ìê²©ì¦', targetCount: 4, achievedCount: 0 },
      { category: 'ì˜ì–´', targetCount: 5, achievedCount: 0 },
      { category: 'ë‹¤ì´ì–´íŠ¸', targetCount: 5, achievedCount: 0 },
      { category: 'ìƒí™œ ìŠµê´€', targetCount: 4, achievedCount: 0 },
      { category: 'ìƒí™œ êµì–‘', targetCount: 2, achievedCount: 0 },
      { category: 'ì±… ì“°ê¸°', targetCount: 2, achievedCount: 0 },
    ];
    const defaultInventory = () => ({
      fragments: { 'íƒì‹ì˜ ë§ˆë„ì„œ':0, 'í™˜ì‹ì˜ ê³„ì•½ì„œ':0, 'í˜„ìì˜ ë³´ê¸‰ ì£¼ë¬¸ì„œ':0, 'ì†Œë§ì˜ ê²°ì •':0 },
      items: { 'íƒì‹ì˜ ë§ˆë„ì„œ':0, 'í™˜ì‹ì˜ ê³„ì•½ì„œ':0, 'í˜„ìì˜ ë³´ê¸‰ ì£¼ë¬¸ì„œ':0, 'ì†Œë§ì˜ ê²°ì •':0 },
    });
    const seedMissions = () => ([
      { id: crypto.randomUUID(), title:'ìœ ì‚°ì†Œ ìš´ë™ 40ë¶„', category:'ë‹¤ì´ì–´íŠ¸', plannedXp:40, done:false, pixelate:true },
      { id: crypto.randomUUID(), title:'í¬ë¡œí‚¤ 2ì¥', category:'ê·¸ë¦¼', plannedXp:35, done:false, pixelate:true },
      { id: crypto.randomUUID(), title:'C ê°•ì˜ 1ê°•', category:'ì½”ë”©/ìê²©ì¦', plannedXp:30, done:false },
      { id: crypto.randomUUID(), title:'ì˜ë‹¨ì–´ ì•”ê¸° 30ë¶„', category:'ì˜ì–´', plannedXp:25, done:false },
    ]);
    const xpForMission = (m, rates) => {
      const base = Number(m.plannedXp)||0;
      const extra = m.isExtra ? base * rates.extraMissionRate : base;
      return m.done ? extra : base * rates.xpPenaltyRate;
    };
    const save = (s) => localStorage.setItem(LS_KEY, JSON.stringify(s));
    const load = () => { try { const raw = localStorage.getItem(LS_KEY); return raw ? JSON.parse(raw) : null } catch { return null } };
    const weekOf = (startDateStr, anyDateStr) => {
      const s = new Date(startDateStr + 'T00:00:00');
      const d = new Date(anyDateStr + 'T00:00:00');
      const diff = Math.floor((d - s)/DAY_MS);
      return Math.max(1, Math.floor(diff/7) + 1);
    };
    function useSfx(enabled, volume){
      const sounds = React.useMemo(()=> ({
        click: new Audio("./click.wav"),
        success: new Audio("./success.wav"),
        fail: new Audio("./fail.wav"),
      }), []);
      React.useEffect(()=> { Object.values(sounds).forEach(a => a.volume = volume); }, [volume]);
      const play = React.useCallback((name) => {
        if(!enabled) return;
        const a = sounds[name];
        if(a){ try { a.currentTime = 0; a.play(); } catch(e){} }
      }, [enabled, sounds]);
      return play;
    }
    function ProgressBar({value}){
      return html`<div className="h-2 bg-slate-200 rounded-xl overflow-hidden"><div className="h-full bg-slate-900" style=${{width: (Math.round(value*100)) + '%'}} /></div>`;
    }
    function Tabs({tabs}){
      const [active, setActive] = React.useState(tabs[0] && tabs[0].key);
      return html`
        <div className="w-full">
          <div className="grid grid-cols-6 border rounded-xl overflow-hidden">
            ${tabs.map(t => html`<button key=${t.key} className=${"px-3 py-2 text-sm " + (active===t.key? 'bg-slate-900 text-white':'bg-white hover:bg-slate-50')} onClick=${() => setActive(t.key)}>${t.label}</button>`)}
          </div>
          <div className="mt-4 card p-4">${(tabs.find(t=>t.key===active)||{}).content}</div>
        </div>`;
    }
    function Missions({day, state, addMission, updateMission, removeMission, toggleDone}){
      const settings = state.settings;
      return html`<div className="space-y-3">
        ${day.missions.length===0 && html`<div className="text-sm text-slate-500">ë¯¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤. ì•„ë˜ ë²„íŠ¼ìœ¼ë¡œ ì¶”ê°€í•´ ë³´ì„¸ìš”.</div>`}
        ${day.missions.map(m => html`
          <div key=${m.id} className="border rounded-xl p-3 grid md:grid-cols-12 gap-2 items-center">
            <div className="md:col-span-3">
              <input className="input" aria-label="ë¯¸ì…˜ ì œëª©" value=${m.title} onChange=${e=> updateMission(m.id, {title:e.target.value})} />
            </div>
            <div className="md:col-span-2">
              <select className="input" value=${m.category} onChange=${e=> updateMission(m.id, {category:e.target.value})}>
                ${CATEGORIES.map(c => html`<option key=${c} value=${c}>${c}</option>`)}
              </select>
            </div>
            <div className="md:col-span-2 flex items-end gap-2">
              <div className="flex-1">
                <div className="label">ì˜ˆì • XP</div>
                <input className="input" type="number" value=${m.plannedXp} onChange=${e=> updateMission(m.id, {plannedXp:Number(e.target.value)})} />
              </div>
              <label className="switch mt-6">
                <input type="checkbox" checked=${!!m.isExtra} onChange=${e=> updateMission(m.id, {isExtra:e.target.checked})} />
                <span></span>
              </label>
              <span className="text-xs">ì¶”ê°€</span>
            </div>
            <div className="md:col-span-3">
              <textarea className="input" rows="2" placeholder="ë©”ëª¨" value=${m.notes||''} onChange=${e=> updateMission(m.id, {notes:e.target.value})}></textarea>
              <div className="grid grid-cols-5 gap-2 mt-2 items-end">
                <div className="col-span-3">
                  <div className="label">ì´ë¯¸ì§€ URL</div>
                  <input className="input" placeholder="https://..." value=${m.imageUrl||''} onChange=${e=> updateMission(m.id, {imageUrl:e.target.value})} />
                </div>
                <label className="col-span-2 flex items-center gap-2">
                  <span className="label">í”½ì…€ì•„íŠ¸ ëª¨ë“œ</span>
                  <span className="switch"><input type="checkbox" checked=${!!m.pixelate} onChange=${e=> updateMission(m.id, {pixelate:e.target.checked})} /><span></span></span>
                </label>
              </div>
            </div>
            <div className="md:col-span-2 flex items-center justify-end gap-2">
              <button className=${"btn " + (m.done? 'btn-primary':'')} onClick=${() => toggleDone(m.id)}>${m.done? 'âœ… ì™„ë£Œ':'â€¦ ë¯¸ì™„ë£Œ'}</button>
              <button className="btn btn-ghost" onClick=${() => removeMission(m.id)}>ğŸ—‘ï¸</button>
            </div>
            ${m.imageUrl && html`<div className="md:col-span-12">
              <img src=${m.imageUrl} alt="ë¯¸ì…˜ ì´ë¯¸ì§€" className=${"w-full max-h-64 object-contain border rounded-xl " + (m.pixelate? 'pixelate':'')} />
            </div>`}
            <div className="md:col-span-12 text-xs text-slate-600 pt-1">
              ì •ì‚° ì˜ˆìƒ XP: ${Math.round(xpForMission(m, { extraMissionRate: settings.extraMissionRate, xpPenaltyRate: settings.xpPenaltyRate }))}
            </div>
          </div>
        `)}
        <div className="flex gap-2">
          <button className="btn" onClick=${() => addMission()}>â• ìƒˆ ë¯¸ì…˜ ë§Œë“¤ê¸°</button>
          <button className="btn" onClick=${() => addMission({ title:'ì˜ë‹¨ì–´ ë³µìŠµ', category:'ì˜ì–´', plannedXp:20, pixelate:true })}>í…œí”Œë¦¿: ì˜ì–´ ë³µìŠµ</button>
          <button className="btn" onClick=${() => addMission({ title:'í¬ë¡œí‚¤ 2ì¥', category:'ê·¸ë¦¼', plannedXp:35, pixelate:true })}>í…œí”Œë¦¿: í¬ë¡œí‚¤</button>
        </div>
      </div>`;
    }
    function Weekly({state, setState}){
      return html`<div className="space-y-4">
        <div className="text-sm text-slate-600">* ì•„ë˜ ëª©í‘œ ê°’ì€ í˜„ì¬ ì£¼ì°¨ì˜ ëª©í‘œì´ë©°, ë¦¬í¬íŠ¸ì˜ í¼ì„¼íŠ¸ ê³„ì‚°ì—ë„ ì‚¬ìš©ë©ë‹ˆë‹¤.</div>
        ${state.weeklyGoals.map((g,i) => html`
          <div key=${g.category} className="border rounded-xl p-3 grid md:grid-cols-12 items-center gap-3">
            <div className="md:col-span-3 font-medium">${g.category}</div>
            <div className="md:col-span-3 flex items-end gap-2">
              <div className="flex-1">
                <div className="label">ëª©í‘œ íšŸìˆ˜</div>
                <input className="input" type="number" value=${g.targetCount} onChange=${e=>{
                  const v = Number(e.target.value);
                  setState(p=> ({...p, weeklyGoals: p.weeklyGoals.map((x,idx)=> idx===i? {...x, targetCount:v}: x)}));
                }} />
              </div>
              <div className="flex-1">
                <div className="label">ë‹¬ì„±(ëˆ„ì )</div>
                <input className="input" type="number" value=${g.achievedCount} onChange=${e=>{
                  const v = Number(e.target.value);
                  setState(p=> ({...p, weeklyGoals: p.weeklyGoals.map((x,idx)=> idx===i? {...x, achievedCount:v}: x)}));
                }} />
              </div>
            </div>
            <div className="md:col-span-6">
              ${ProgressBar({ value: Math.min(1, (g.achievedCount||0)/Math.max(1,g.targetCount||0)) })}
            </div>
          </div>
        `)}
      </div>`;
    }
    function InventoryPanel({state, setState}){
      const keys = Object.keys(state.inventory.fragments);
      return html`<div className="grid md:grid-cols-2 gap-4">
        <div className="card p-4">
          <div className="text-base font-semibold mb-2">ğŸ² ì¡°ê°</div>
          <div className="space-y-2">
            ${keys.map(k => html`
              <div key=${k} className="flex items-center justify-between">
                <div>${k}</div>
                <div className="flex items-center gap-2">
                  <span className="px-2 py-1 rounded-xl bg-slate-100">${state.inventory.fragments[k]}ê°œ</span>
                  <button className="btn" onClick=${() => {
                    setState(p => {
                      const inv = JSON.parse(JSON.stringify(p.inventory));
                      inv.fragments[k] += 1;
                      while(inv.fragments[k] >= 5){ inv.fragments[k]-=5; inv.items[k]+=1; }
                      return {...p, inventory: inv};
                    });
                  }}>+1</button>
                </div>
              </div>
            `)}
          </div>
        </div>
        <div className="card p-4">
          <div className="text-base font-semibold mb-2">âœ¨ ì™„ì„± ì•„ì´í…œ</div>
          <div className="space-y-2">
            ${Object.keys(state.inventory.items).map(k => html`
              <div key=${k} className="flex items-center justify-between">
                <div>${k}</div>
                <span className="px-2 py-1 rounded-xl bg-slate-100">${state.inventory.items[k]}ê°œ</span>
              </div>
            `)}
          </div>
        </div>
        <div className="text-xs text-slate-600 md:col-span-2">* ë¯¸ë‹ˆë³´ìŠ¤ ìŠ¹ë¦¬ ì‹œ ë¬´ì‘ìœ„ ì¡°ê° 1ê°œ íšë“. ì¡°ê° 5ê°œê°€ ë˜ë©´ ìë™ìœ¼ë¡œ í•©ì„±ë©ë‹ˆë‹¤.</div>
      </div>`;
    }
    function Recommended({onAdd}){
      const templates = [
        { title:'í¬ë¡œí‚¤ 2ì¥', category:'ê·¸ë¦¼', plannedXp:35, pixelate:true, hint:'7ì£¼ì°¨ ëª©í‘œ 5íšŒ' },
        { title:'ìœ ì‚°ì†Œ ìš´ë™ 40ë¶„', category:'ë‹¤ì´ì–´íŠ¸', plannedXp:40, pixelate:true, hint:'ì£¼ 5íšŒ ë£¨í‹´' },
        { title:'36ì‹œê°„ ë‹¨ì‹ ì¤€ë¹„/íšŒë³µê¸°ë¡', category:'ë‹¤ì´ì–´íŠ¸', plannedXp:25, hint:'ì£¼ 2íšŒ' },
        { title:'ìŠ¤ë§ˆíŠ¸í° ë””í†¡ìŠ¤ 3ì‹œê°„', category:'ìƒí™œ ìŠµê´€', plannedXp:30, hint:'ì£¼ 3íšŒ' },
        { title:'ì˜ë‹¨ì–´ ì•”ê¸° 30ë¶„', category:'ì˜ì–´', plannedXp:25, pixelate:true, hint:'ì£¼ 5íšŒ' },
        { title:'ì˜ì–´ ì˜ìƒ ì‹œì²­ 20ë¶„', category:'ì˜ì–´', plannedXp:20, hint:'ì£¼ 3íšŒ' },
        { title:'C ì–¸ì–´ ê°•ì˜ 1ê°•', category:'ì½”ë”©/ìê²©ì¦', plannedXp:30, hint:'ì§„ë„ ë§ˆë¬´ë¦¬' },
        { title:'í”½ì…€ ì•„íŠ¸ ê°•ì˜ 1ê°•', category:'ê·¸ë¦¼', plannedXp:28, pixelate:true, hint:'ì£¼ 3íšŒ' },
        { title:'ì¸ì²´ ë“œë¡œì‰ ì±… ë³µìŠµ', category:'ê·¸ë¦¼', plannedXp:22, pixelate:true },
        { title:'ë…ì„œ 30ìª½', category:'ìƒí™œ êµì–‘', plannedXp:20, hint:'ë§ˆì˜ì‚°/ê±¸ë¦¬ë²„' },
        { title:'ì¹´ë“œë‰´ìŠ¤ 3ê°œ', category:'ìƒí™œ êµì–‘', plannedXp:15 },
      ];
      return html`<div className="grid md:grid-cols-2 gap-3">
        ${templates.map((t,i) => html`
          <div key=${i} className="card p-4 flex items-center justify-between">
            <div>
              <div className="font-medium">âœ¨ ${t.title}</div>
              ${t.hint && html`<div className="text-sm text-slate-600">${t.hint}</div>`}
              <div className="text-xs text-slate-600 mt-1">ì¹´í…Œê³ ë¦¬: ${t.category}</div>
            </div>
            <div className="flex items-center gap-2">
              <span className="px-2 py-1 rounded-xl bg-slate-100">XP ${t.plannedXp}</span>
              <button className="btn btn-primary" onClick=${() => onAdd(t)}>ë‹´ê¸°</button>
            </div>
          </div>
        `)}
      </div>`;
    }
    function Report({weeklyReport, targets, onExportCSV}){
      const cats = Object.keys(targets);
      if(!weeklyReport || weeklyReport.length===0){
        return html`<div className="text-sm text-slate-500">ì§‘ê³„í•  ë°ì´í„°ê°€ ì•„ì§ ì—†ì–´ìš”. ë¯¸ì…˜ì„ ì™„ë£Œí•˜ê³  ë‹¤ì‹œ í™•ì¸í•´ ë³´ì„¸ìš”.</div>`;
      }
      return html`<div className="space-y-4">
        <div className="flex items-center justify-between">
          <div className="text-base font-semibold">ğŸ“Š ì£¼ì°¨ë³„ ë‹¬ì„± ë¦¬í¬íŠ¸</div>
          <button className="btn" onClick=${onExportCSV}>CSVë¡œ ë‚´ë³´ë‚´ê¸°</button>
        </div>
        <div className="overflow-x-auto">
          <table className="w-full text-sm">
            <thead>
              <tr className="text-left border-b">
                <th className="py-2 pr-3">ì£¼ì°¨</th>
                <th className="py-2 pr-3">ì¢…í•© ë‹¬ì„±ë¥ </th>
                ${cats.map(c => html`<th key=${c} className="py-2 pr-3">${c}</th>`)}
              </tr>
            </thead>
            <tbody>
              ${weeklyReport.map(r => html`
                <tr key=${r.weekNo} className="border-b last:border-0 align-top">
                  <td className="py-2 pr-3 font-medium">${r.weekNo}ì£¼ì°¨</td>
                  <td className="py-2 pr-3" style=${{minWidth:'160px'}}>
                    <div className="flex items-center gap-2">
                      <div className="w-40">${ProgressBar({ value: r.overallPct })}</div>
                      <div className="w-10 text-right">${Math.round(r.overallPct*100)}%</div>
                    </div>
                  </td>
                  ${cats.map(c => {
                    const done = r.byCat[c] || 0;
                    const target = targets[c] || 0;
                    const pct = target ? Math.min(1, done/target) : 0;
                    return html`<td key=${c} className="py-2 pr-3">
                      <div className="flex items-center gap-2">
                        <div className="w-32">${ProgressBar({ value: pct })}</div>
                        <div className="w-16 text-right">${done} / ${target}</div>
                      </div>
                    </td>`;
                  })}
                </tr>
              `)}
            </tbody>
          </table>
        </div>
        <div className="text-xs text-slate-500">* ë‹¬ì„± ìˆ˜ì¹˜ëŠ” ê° ë‚ ì§œì˜ ì™„ë£Œëœ ë¯¸ì…˜ì„ ê¸°ë°˜ìœ¼ë¡œ ìë™ ì§‘ê³„ë©ë‹ˆë‹¤. ëª©í‘œì¹˜ëŠ” í˜„ì¬ â€œì£¼ê°„ ëª©í‘œâ€ì˜ ëª©í‘œ íšŸìˆ˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ %ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.</div>
      </div>`;
    }
    function Settings({state, setState}){
      const s = state.settings;
      return html`<div className="grid md:grid-cols-2 gap-4">
        <div className="border rounded-xl p-3 space-y-3">
          <div className="grid grid-cols-2 gap-2 items-end">
            <div>
              <div className="label">ì‹¤íŒ¨ í˜ë„í‹°(%)</div>
              <input className="input" type="number" value=${Math.round(s.xpPenaltyRate*100)} onChange=${e=> setState(p=>({...p, settings:{...p.settings, xpPenaltyRate: Number(e.target.value)/100 }}))} />
            </div>
            <div>
              <div className="label">ì¶”ê°€ ë¯¸ì…˜ ë³´ìƒ(%)</div>
              <input className="input" type="number" value=${Math.round(s.extraMissionRate*100)} onChange=${e=> setState(p=>({...p, settings:{...p.settings, extraMissionRate: Number(e.target.value)/100 }}))} />
            </div>
          </div>
          <div className="grid grid-cols-2 gap-2 items-end">
            <div>
              <div className="label">ë¯¸ë‹ˆë³´ìŠ¤ ì¡°ê° ë³´ìƒ</div>
              <input className="input" type="number" value=${s.minibossRewardFragments} onChange=${e=> setState(p=>({...p, settings:{...p.settings, minibossRewardFragments: Number(e.target.value) }}))} />
            </div>
            <div>
              <div className="label">í‘œì‹œ ë¡œì¼€ì¼</div>
              <input className="input" value=${s.locale} onChange=${e=> setState(p=>({...p, settings:{...p.settings, locale: e.target.value }}))} />
            </div>
          </div>
          <div className="grid grid-cols-2 gap-2 items-end">
            <label className="flex items-center gap-2">
              <span className="label">íš¨ê³¼ìŒ</span>
              <span className="switch"><input type="checkbox" checked=${!!s.sfx} onChange=${e=> setState(p=> ({...p, settings:{...p.settings, sfx: e.target.checked}}))} /><span></span></span>
            </label>
            <div>
              <div className="label">íš¨ê³¼ìŒ ë³¼ë¥¨</div>
              <input className="w-full" type="range" min="0" max="1" step="0.01" value=${s.sfxVolume} onChange=${e=> setState(p=> ({...p, settings:{...p.settings, sfxVolume: Number(e.target.value)}}))} />
            </div>
          </div>
          <div className="grid grid-cols-2 gap-2 items-end">
            <label className="flex items-center gap-2">
              <span className="label">ì£¼ì°¨ ìë™ ê³„ì‚°</span>
              <span className="switch"><input type="checkbox" checked=${!!s.autoWeek} onChange=${e=> setState(p=> ({...p, settings:{...p.settings, autoWeek: e.target.checked}}))} /><span></span></span>
            </label>
            <div>
              <div className="label">ì‹œì‘ì¼ (ì²« ì£¼ 1ì£¼ì°¨)</div>
              <input className="input" type="date" value=${s.weekStartDate} onChange=${e=> setState(p=> ({...p, settings:{...p.settings, weekStartDate: e.target.value}}))} />
            </div>
          </div>
          <div className="flex items-center justify-between pt-2">
            <button className="btn" onClick=${() => { localStorage.removeItem(LS_KEY); location.reload(); }}>ëª¨ë‘ ì´ˆê¸°í™”</button>
            <div className="text-xs text-slate-500">ë¸Œë¼ìš°ì €ì— ìë™ ì €ì¥ë©ë‹ˆë‹¤.</div>
          </div>
        </div>
        <div className="border rounded-xl p-3 space-y-3">
          <div className="text-sm font-medium">ë¹ ë¥¸ ë©”ëª¨</div>
          <textarea className="input" rows="8" placeholder="ê·¸ë‚ ì˜ ì»¨ë””ì…˜, ê¹¨ë‹¬ìŒ, íšŒê³  ë“±ì„ ê¸°ë¡í•˜ì„¸ìš”." value=${state.quickNote} onChange=${e=> setState(p=> ({...p, quickNote: e.target.value}))}></textarea>
        </div>
      </div>`;
    }
    function App(){
      const [state, setState] = React.useState(() => load() ?? ({
        profile: { level: 8, xp: 309, nextLevelXp: 700 },
        weekNumber: 7,
        weeklyGoals: defaultWeeklyGoals,
        days: { [todayStr]: { date: todayStr, missions: seedMissions(), settled:false, dayXpAwarded:0 } },
        inventory: defaultInventory(),
        settings: { xpPenaltyRate:0.5, extraMissionRate:0.6, minibossRewardFragments:1, locale:'ko-KR', sfx:true, sfxVolume:0.4, autoWeek:true, weekStartDate: todayStr },
        quickNote: ''
      }));
      const [selectedDate, setSelectedDate] = React.useState(todayStr);
      const playSfx = useSfx(state.settings.sfx, state.settings.sfxVolume);
      React.useEffect(() => { save(state); }, [state]);
      const day = React.useMemo(() => state.days[selectedDate] || { date:selectedDate, missions:[], settled:false, dayXpAwarded:0 }, [state, selectedDate]);
      React.useEffect(() => { if(!state.days[selectedDate]){ setState(prev => ({...prev, days:{...prev.days, [selectedDate]: { date:selectedDate, missions:[], settled:false, dayXpAwarded:0 }}})); } }, [selectedDate]);
      const completionRate = React.useMemo(() => {
        const total = day.missions.length || 1;
        const done = day.missions.filter(m=>m.done).length;
        return done/total;
      }, [day.missions]);
      const minibossChance = percent(clamp01(completionRate * 1.2));
      const currentWeekAuto = weekOf(state.settings.weekStartDate, selectedDate);
      const displayWeek = state.settings.autoWeek ? currentWeekAuto : (state.weekNumber || 1);
      function addMission(partial={}){
        const m = { id:crypto.randomUUID(), title:'ìƒˆ ë¯¸ì…˜', category:'ìƒí™œ ìŠµê´€', plannedXp:20, done:false, ...partial };
        setState(prev=> ({...prev, days:{...prev.days, [selectedDate]: {...day, missions:[...day.missions, m] }}}));
        playSfx('click');
      }
      function updateMission(id, patch){
        setState(prev=> ({...prev, days:{...prev.days, [selectedDate]: {...day, missions: day.missions.map(m=> m.id===id? {...m, ...patch}: m) }}}));
      }
      function removeMission(id){
        setState(prev=> ({...prev, days:{...prev.days, [selectedDate]: {...day, missions: day.missions.filter(m=>m.id!==id) }}}));
      }
      function toggleDone(id){
        const m = day.missions.find(x=>x.id===id);
        const to = !(m && m.done);
        updateMission(id, {done: to});
        playSfx('click');
      }
      function settleDay(){
        if(day.settled) return;
        const { xpPenaltyRate, extraMissionRate } = state.settings;
        const awarded = Math.round(day.missions.reduce((s,m)=> s + xpForMission(m,{xpPenaltyRate, extraMissionRate}), 0));
        let level = state.profile.level;
        let xp = state.profile.xp + awarded;
        let next = state.profile.nextLevelXp;
        while(xp >= next){ xp -= next; level += 1; next = Math.round(next * 1.25); }
        const chance = minibossChance;
        const success = Math.random()*100 < chance;
        const inv = JSON.parse(JSON.stringify(state.inventory));
        if(success){
          const keys = ['íƒì‹ì˜ ë§ˆë„ì„œ','í™˜ì‹ì˜ ê³„ì•½ì„œ','í˜„ìì˜ ë³´ê¸‰ ì£¼ë¬¸ì„œ','ì†Œë§ì˜ ê²°ì •'];
          const k = keys[Math.floor(Math.random()*keys.length)];
          inv.fragments[k] += state.settings.minibossRewardFragments;
          for(const key of keys){ while(inv.fragments[key] >= 5){ inv.fragments[key]-=5; inv.items[key]+=1; } }
        }
        const inc = {}; day.missions.filter(m=>m.done).forEach(m=>{ inc[m.category] = (inc[m.category]||0)+1; });
        const newWeekly = state.weeklyGoals.map(g=> ({...g, achievedCount: g.achievedCount + (inc[g.category]||0)}));
        const newDay = { ...day, settled:true, dayXpAwarded: awarded, minibossResult: success? 'ì„±ê³µ':'ì‹¤íŒ¨', minibossChance: chance };
        setState(prev=> ({...prev, profile:{level, xp, nextLevelXp:next}, days:{...prev.days, [selectedDate]: newDay}, weeklyGoals:newWeekly, inventory:inv }));
        playSfx(success ? 'success' : 'fail');
      }
      function exportData(){
        const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
        const url = URL.createObjectURL(blob); const a=document.createElement('a');
        a.href = url; a.download = `ì„±ì‹¤ë ˆë²¨ì—…_${displayWeek}ì£¼ì°¨_${selectedDate}.json`; a.click(); URL.revokeObjectURL(url);
      }
      function importData(file){ const r = new FileReader(); r.onload=()=>{ try{ const s=JSON.parse(String(r.result)); setState(s); alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ì–´ìš”!'); }catch{ alert('ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: JSON í˜•ì‹ ì˜¤ë¥˜'); } }; r.readAsText(file); }
      const reportTargets = React.useMemo(()=> {
        const m = {}; state.weeklyGoals.forEach(g => m[g.category] = g.targetCount || 0);
        return m;
      }, [state.weeklyGoals]);
      const totalTargetPerWeek = React.useMemo(()=> Object.values(reportTargets).reduce((a,b)=>a+b,0) || 1, [reportTargets]);
      const weeklyReport = React.useMemo(()=>{
        const map = {};
        Object.values(state.days).forEach(d => {
          const w = weekOf(state.settings.weekStartDate, d.date);
          map[w] = map[w] || { byCat:{}, totalDone:0 };
          d.missions.forEach(m => {
            if(m.done){
              map[w].byCat[m.category] = (map[w].byCat[m.category]||0) + 1;
              map[w].totalDone += 1;
            }
          });
        });
        const rows = Object.keys(map).map(k => Number(k)).sort((a,b)=>a-b).map(weekNo => {
          const byCat = map[weekNo].byCat;
          const overallPct = Math.min(1, (Object.keys(reportTargets).reduce((s,cat)=> s + Math.min(byCat[cat]||0, reportTargets[cat]||0), 0)) / totalTargetPerWeek);
          return { weekNo, byCat, overallPct };
        });
        return rows;
      }, [state.days, state.settings.weekStartDate, reportTargets, totalTargetPerWeek]);
      function exportReportCSV(){
        const cats = Object.keys(reportTargets);
        let lines = [];
        lines.push(["week","overall_pct", ...cats].join(","));
        weeklyReport.forEach(r => {
          const row = [r.weekNo, Math.round(r.overallPct*100)];
          cats.forEach(c => row.push(r.byCat[c]||0));
          lines.push(row.join(","));
        });
        const blob = new Blob([lines.join("\n")], {type:"text/csv"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a"); a.href = url; a.download = "weekly_report.csv"; a.click(); URL.revokeObjectURL(url);
      }
      const weekProgress = state.weeklyGoals.reduce((acc,g)=>{ acc.total += g.targetCount; acc.current += Math.min(g.achievedCount, g.targetCount); return acc; }, {total:0, current:0});
      return html`<div className="max-w-6xl mx-auto grid gap-6">
        <div className="flex items-center justify-between gap-3">
          <div className="flex items-center gap-3 flex-wrap">
            <div className="text-2xl">âœ¨</div>
            <h1 className="text-2xl md:text-3xl font-bold">ì„±ì‹¤ ë ˆë²¨ ì—… í”„ë¡œì íŠ¸ (PWA)</h1>
            <div className="flex items-center gap-2">
              <span className="px-2 py-1 rounded-xl bg-slate-100 text-slate-700 text-sm">ì£¼ì°¨</span>
              ${state.settings.autoWeek ? html`<div className="flex items-center gap-2">
                <span className="px-2 py-1 rounded-xl bg-slate-100">${weekOf(state.settings.weekStartDate, selectedDate)}ì£¼ì°¨</span>
                <span className="text-xs text-slate-500">ìë™</span>
              </div>` : html`<div className="flex items-center gap-2">
                <button className="btn" onClick=${() => setState(p=> ({...p, weekNumber: Math.max(1, (p.weekNumber||1)-1)}))}>-</button>
                <input className="input w-20 text-center" type="number" min="1" value=${state.weekNumber} onChange=${e=> setState(p=> ({...p, weekNumber: Math.max(1, Number(e.target.value)||1)}))} />
                <button className="btn" onClick=${() => setState(p=> ({...p, weekNumber: (p.weekNumber||1)+1}))}>+</button>
                <span className="text-xs text-slate-500">ìˆ˜ë™</span>
              </div>`}
            </div>
          </div>
          <div className="flex items-center gap-2">
            <button className="btn" onClick=${exportData}>â¬‡ï¸ ë‚´ë³´ë‚´ê¸°</button>
            <label className="btn cursor-pointer">â¬†ï¸ ê°€ì ¸ì˜¤ê¸°
              <input type="file" accept="application/json" className="hidden" onChange=${e=>{ const f=e.target.files&&e.target.files[0]; if(f) importData(f); }}/>
            </label>
          </div>
        </div>
        <div className="grid md:grid-cols-3 gap-4">
          <div className="card p-4">
            <div className="text-lg font-semibold mb-3">ğŸ›¡ï¸ í”„ë¡œí•„</div>
            <div className="grid grid-cols-3 gap-3 items-end">
              <div><div className="label">ë ˆë²¨</div><input className="input" type="number" value=${state.profile.level} onChange=${e=> setState(p=>({...p, profile:{...p.profile, level:Number(e.target.value)}}))} /></div>
              <div><div className="label">ê²½í—˜ì¹˜</div><input className="input" type="number" value=${state.profile.xp} onChange=${e=> setState(p=>({...p, profile:{...p.profile, xp:Number(e.target.value)}}))} /></div>
              <div><div className="label">ë‹¤ìŒ ë ˆë²¨ í•„ìš”ì¹˜</div><input className="input" type="number" value=${state.profile.nextLevelXp} onChange=${e=> setState(p=>({...p, profile:{...p.profile, nextLevelXp:Number(e.target.value)}}))} /></div>
            </div>
          </div>
          <div className="card p-4">
            <div className="text-lg font-semibold mb-3">ğŸ“… ì˜¤ëŠ˜</div>
            <div className="grid gap-3">
              <div className="flex items-center gap-2">
                <input className="input" type="date" value=${selectedDate} onChange=${e=> setSelectedDate(e.target.value)} />
                <button className="btn" onClick=${() => setSelectedDate(todayStr)}>ì˜¤ëŠ˜</button>
              </div>
              <div className="flex items-center justify-between"><div className="text-sm text-slate-600">ë‹¬ì„±ë¥ </div><div className="text-lg font-semibold">${percent(completionRate)}%</div></div>
              ${ProgressBar({ value: completionRate })}
              <div className="flex items-center justify-between"><div className="text-sm text-slate-600">ë¯¸ë‹ˆë³´ìŠ¤ ìŠ¹ë¥ </div><div className="text-lg font-semibold">${percent(clamp01(completionRate*1.2))}%</div></div>
              ${day.settled ? html`<div className="text-sm text-emerald-700 bg-emerald-50 border border-emerald-200 rounded-xl p-2">ì •ì‚° ì™„ë£Œ â€¢ íšë“ XP ${day.dayXpAwarded} â€¢ ë¯¸ë‹ˆë³´ìŠ¤ ${day.minibossResult} (${day.minibossChance}%)</div>`
              : html`<button className="btn btn-primary w-full" onClick=${() => settleDay()}>ğŸ—¡ï¸ í•˜ë£¨ ë Â· ì •ì‚°</button>`}
            </div>
          </div>
          <div className="card p-4">
            <div className="text-lg font-semibold mb-3">ğŸ† ì£¼ê°„ ì§„í–‰</div>
            <div className="space-y-3">
              <div className="text-sm text-slate-600">ì£¼ê°„ ì¢…í•© ì§„í–‰ë¥ </div>
              ${ProgressBar({ value: (weekProgress.current/(weekProgress.total||1)) })}
              <div className="text-sm">${weekProgress.current} / ${weekProgress.total}</div>
              <div className="text-sm font-medium">${state.weeklyGoals.every(g=> g.achievedCount >= g.targetCount) ? 'ì£¼ê°„ ë³´ìƒ ì¡°ê±´ ë‹¬ì„±! (ì „ í•­ëª© ë‹¬ì„±)' : 'ë¶€ë¶„ ë‹¬ì„±: ë³´ìƒ ì—†ìŒ'}</div>
              <button className="btn" onClick=${() => { if(!confirm('ì´ë²ˆ ì£¼ ì§„í–‰ë„ë¥¼ 0ìœ¼ë¡œ ì´ˆê¸°í™”í• ê¹Œìš”?')) return; setState(prev=> ({...prev, weekNumber: prev.weekNumber+1, weeklyGoals: prev.weeklyGoals.map(g=>({...g, achievedCount:0})) })); }}>ì£¼ì°¨ ë§ˆê° & ì´ˆê¸°í™”</button>
            </div>
          </div>
        </div>
        ${Tabs({ tabs: [
          { key:'missions', label:'ì˜¤ëŠ˜ì˜ ë¯¸ì…˜', content: Missions({ day, state, addMission, updateMission, removeMission, toggleDone }) },
          { key:'weekly', label:'ì£¼ê°„ ëª©í‘œ', content: Weekly({ state, setState }) },
          { key:'report', label:'ì£¼ì°¨ ë¦¬í¬íŠ¸', content: Report({ weeklyReport, targets: reportTargets, onExportCSV: exportReportCSV }) },
          { key:'inventory', label:'ì¸ë²¤í† ë¦¬', content: InventoryPanel({ state, setState }) },
          { key:'recommend', label:'ì¶”ì²œ ë¯¸ì…˜', content: Recommended({ onAdd: addMission }) },
          { key:'settings', label:'ì„¤ì •', content: Settings({ state, setState }) },
        ]})}
        <div className="text-center text-xs text-slate-500 py-6">Â© ${new Date().getFullYear()} ì„±ì‹¤ ë ˆë²¨ ì—… í”„ë¡œì íŠ¸ Â· PWA</div>
      </div>`;
    }
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(html`<${App} />`);
  </script>
</body>
</html>